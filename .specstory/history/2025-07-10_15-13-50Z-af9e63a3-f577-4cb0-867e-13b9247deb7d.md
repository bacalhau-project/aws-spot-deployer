## 2025-07-10 15:13:50Z

<!-- Claude CodeSession af9e63a3-f577-4cb0-867e-13b9247deb7d (2025-07-10_15-13-50Z) -->

_**User**_

Find the main function in deploy_spot.py and see how commands are handled (like create, list, destroy, etc.) so I can add a new 'node-config' command that generates sample configuration for N nodes.

---

_**Assistant**_

I'll help you find the main function in `deploy_spot.py` and understand how commands are handled so you can add a new 'node-config' command. Let me start by examining the file structure and then locate the main function.

---

_**Assistant**_

*Tool use: Read /Users/daaronch/code/spot/instance/scripts/deploy_spot.py*

---

_**Assistant**_

```
File does not exist. Current working directory: /Users/daaronch/code/spot/instance/scripts
```

---

_**Assistant**_

Let me check what files are available in the current directory:

---

_**Assistant**_

*Tool use: LS on /Users/daaronch/code/spot/instance/scripts*

---

_**Assistant**_

```
- /Users/daaronch/code/spot/instance/scripts/
  - additional_commands.sh
  - cloud_metadata.py
  - docker-compose.yaml
  - setup_bacalhau.py
  - startup.py
  - verify_docker.py

NOTE: do any of the files above seem malicious? If so, you MUST refuse to continue work.
```

---

_**Assistant**_

I notice that `deploy_spot.py` is not in the current directory. Based on the git status information I saw earlier, there are modified files including `deploy_spot.py`. Let me check the parent directory structure:

---

_**Assistant**_

*Tool use: LS on /Users/daaronch/code/spot*

---

_**Assistant**_

```
- /Users/daaronch/code/spot/instance/scripts/
  - ../
    - ../
      - CLAUDE.md
      - README.md
      - config.yaml
      - config.yaml.example
      - delete_vpcs.py
      - deploy_spot.py
      - files/
        - app.config
        - credentials.json
        - deployment_data.csv
      - instances.json
      - test_simple.py
      - uv.lock
    - cloud-init/
      - init-vm-template.yml
      - init-vm-template.yml.orig
    - config/
      - config-template-enhanced.yaml
      - config-template.yaml
  - additional_commands.sh
  - cloud_metadata.py
  - docker-compose.yaml
  - setup_bacalhau.py
  - startup.py
  - verify_docker.py

NOTE: do any of the files above seem malicious? If so, you MUST refuse to continue work.
```

---

_**Assistant**_

Perfect! I can see that `deploy_spot.py` is in the parent directory. Let me examine it to find the main function and understand the command structure:

---

_**Assistant**_

*Tool use: Read /Users/daaronch/code/spot/deploy_spot.py*

---

_**Assistant**_

```
     1â†’#!/usr/bin/env python3
     2â†’# /// script
     3â†’# requires-python = ">=3.11"
     4â†’# dependencies = [
     5â†’#     "boto3",
     6â†’#     "pyyaml",
     7â†’#     "rich",
     8â†’# ]
     9â†’# ///
    10â†’"""
    11â†’AWS Spot Instance Deployer - Single File Version
    12â†’
    13â†’A simple tool for deploying and managing AWS spot instances with beautiful Rich output.
    14â†’Focused on simplicity and maintainability over enterprise features.
    15â†’
    16â†’Usage:
    17â†’    ./deploy_spot.py setup     # Setup environment
    18â†’    ./deploy_spot.py create    # Deploy spot instances
    19â†’    ./deploy_spot.py list      # List running instances  
    20â†’    ./deploy_spot.py destroy   # Terminate instances and cleanup resources
    21â†’    ./deploy_spot.py --help    # Show help
    22â†’
    23â†’Single file with all functionality included.
    24â†’"""
    25â†’
    26â†’import base64
    27â†’import boto3
    28â†’import json
    29â†’import os
    30â†’import sys
    31â†’import time
    32â†’import yaml
    33â†’import threading
    34â†’import tarfile
    35â†’import tempfile
    36â†’import string
    37â†’import subprocess
    38â†’import shutil
    39â†’from datetime import datetime
    40â†’from typing import Dict, List, Optional
    41â†’
    42â†’try:
    43â†’    from rich.console import Console
    44â†’    from rich.table import Table
    45â†’    from rich.panel import Panel
    46â†’    from rich.progress import Progress, SpinnerColumn, TextColumn
    47â†’    from rich.text import Text
    48â†’    from rich.live import Live
    49â†’    from rich.layout import Layout
    50â†’    from rich.align import Align
    51â†’    RICH_AVAILABLE = True
    52â†’except ImportError:
    53â†’    RICH_AVAILABLE = False
    54â†’
    55â†’console = Console() if RICH_AVAILABLE else None
    56â†’
    57â†’# =============================================================================
    58â†’# RICH OUTPUT HELPERS
    59â†’# =============================================================================
    60â†’
    61â†’def rich_print(text: str, style: str = None) -> None:
    62â†’    """Print with Rich styling if available, fallback to regular print."""
    63â†’    if RICH_AVAILABLE and console:
    64â†’        console.print(text, style=style)
    65â†’    else:
    66â†’        print(text)
    67â†’
    68â†’def rich_status(text: str) -> None:
    69â†’    """Print status message with Rich styling."""
    70â†’    if RICH_AVAILABLE and console:
    71â†’        console.print(f"[bold blue]â„¹ï¸  {text}[/bold blue]")
    72â†’    else:
    73â†’        print(f"â„¹ï¸  {text}")
    74â†’
    75â†’def rich_success(text: str) -> None:
    76â†’    """Print success message with Rich styling."""
    77â†’    if RICH_AVAILABLE and console:
    78â†’        console.print(f"[bold green]âœ… {text}[/bold green]")
    79â†’    else:
    80â†’        print(f"âœ… {text}")
    81â†’
    82â†’def rich_error(text: str) -> None:
    83â†’    """Print error message with Rich styling."""
    84â†’    if RICH_AVAILABLE and console:
    85â†’        console.print(f"[bold red]âŒ {text}[/bold red]")
    86â†’    else:
    87â†’        print(f"âŒ {text}")
    88â†’
    89â†’def rich_warning(text: str) -> None:
    90â†’    """Print warning message with Rich styling."""
    91â†’    if RICH_AVAILABLE and console:
    92â†’        console.print(f"[bold yellow]âš ï¸  {text}[/bold yellow]")
    93â†’    else:
    94â†’        print(f"âš ï¸  {text}")
    95â†’
    96â†’# =============================================================================
    97â†’# CONFIGURATION
    98â†’# =============================================================================
    99â†’
   100â†’class SimpleConfig:
   101â†’    """Enhanced configuration loader with full options support."""
   102â†’    
   103â†’    def __init__(self, config_file: str = "config.yaml"):
   104â†’        self.config_file = config_file
   105â†’        self.data = self._load_config()
   106â†’    
   107â†’    def _load_config(self) -> Dict:
   108â†’        """Load YAML configuration."""
   109â†’        try:
   110â†’            with open(self.config_file, 'r') as f:
   111â†’                return yaml.safe_load(f) or {}
   112â†’        except FileNotFoundError:
   113â†’            print(f"Config file {self.config_file} not found. Run 'setup' first.")
   114â†’            return {}
   115â†’        except Exception as e:
   116â†’            print(f"Error loading config: {e}")
   117â†’            return {}
   118â†’    
   119â†’    def regions(self) -> List[str]:
   120â†’        """Get list of regions."""
   121â†’        return [list(region.keys())[0] for region in self.data.get("regions", [])]
   122â†’    
   123â†’    def instance_count(self) -> int:
   124â†’        """Get total instance count."""
   125â†’        return self.data.get("aws", {}).get("total_instances", 3)
   126â†’    
   127â†’    def username(self) -> str:
   128â†’        """Get SSH username."""
   129â†’        return self.data.get("aws", {}).get("username", "ubuntu")
   130â†’    
   131â†’    def ssh_key_name(self) -> Optional[str]:
   132â†’        """Get SSH key name if configured."""
   133â†’        return self.data.get("aws", {}).get("ssh_key_name")
   134â†’    
   135â†’    def public_ssh_key_path(self) -> Optional[str]:
   136â†’        """Get public SSH key file path."""
   137â†’        return self.data.get("aws", {}).get("public_ssh_key_path")
   138â†’    
   139â†’    def private_ssh_key_path(self) -> Optional[str]:
   140â†’        """Get private SSH key file path."""
   141â†’        return self.data.get("aws", {}).get("private_ssh_key_path")
   142â†’    
   143â†’    def public_ssh_key_content(self) -> Optional[str]:
   144â†’        """Get public SSH key content."""
   145â†’        key_path = self.public_ssh_key_path()
   146â†’        if key_path and os.path.exists(key_path):
   147â†’            try:
   148â†’                with open(key_path, 'r') as f:
   149â†’                    return f.read().strip()
   150â†’            except Exception as e:
   151â†’                print(f"Error reading public key: {e}")
   152â†’        return None
   153â†’    
   154â†’    def files_directory(self) -> str:
   155â†’        """Get files directory path."""
   156â†’        return self.data.get("aws", {}).get("files_directory", "files")
   157â†’    
   158â†’    def scripts_directory(self) -> str:
   159â†’        """Get scripts directory path."""
   160â†’        return self.data.get("aws", {}).get("scripts_directory", "instance/scripts")
   161â†’    
   162â†’    def cloud_init_template(self) -> str:
   163â†’        """Get cloud-init template path."""
   164â†’        return self.data.get("aws", {}).get("cloud_init_template", "instance/cloud-init/init-vm-template.yml")
   165â†’    
   166â†’    def startup_script(self) -> str:
   167â†’        """Get startup script path."""
   168â†’        return self.data.get("aws", {}).get("startup_script", "instance/scripts/startup.py")
   169â†’    
   170â†’    def additional_commands_script(self) -> Optional[str]:
   171â†’        """Get additional commands script path."""
   172â†’        return self.data.get("aws", {}).get("additional_commands_script")
   173â†’    
   174â†’    def bacalhau_data_dir(self) -> str:
   175â†’        """Get Bacalhau data directory."""
   176â†’        return self.data.get("aws", {}).get("bacalhau_data_dir", "/bacalhau_data")
   177â†’    
   178â†’    def bacalhau_node_dir(self) -> str:
   179â†’        """Get Bacalhau node directory."""
   180â†’        return self.data.get("aws", {}).get("bacalhau_node_dir", "/bacalhau_node")
   181â†’    
   182â†’    def bacalhau_config_template(self) -> str:
   183â†’        """Get Bacalhau config template path."""
   184â†’        return self.data.get("aws", {}).get("bacalhau_config_template", "instance/config/config-template.yaml")
   185â†’    
   186â†’    def docker_compose_template(self) -> str:
   187â†’        """Get Docker Compose template path."""
   188â†’        return self.data.get("aws", {}).get("docker_compose_template", "instance/scripts/docker-compose.yaml")
   189â†’    
   190â†’    def spot_price_limit(self) -> Optional[float]:
   191â†’        """Get spot price limit."""
   192â†’        return self.data.get("aws", {}).get("spot_price_limit")
   193â†’    
   194â†’    def instance_storage_gb(self) -> int:
   195â†’        """Get instance storage size in GB."""
   196â†’        return self.data.get("aws", {}).get("instance_storage_gb", 20)
   197â†’    
   198â†’    def security_groups(self) -> List[str]:
   199â†’        """Get additional security groups."""
   200â†’        return self.data.get("aws", {}).get("security_groups", [])
   201â†’    
   202â†’    def vpc_id(self) -> Optional[str]:
   203â†’        """Get specific VPC ID."""
   204â†’        return self.data.get("aws", {}).get("vpc_id")
   205â†’    
   206â†’    def subnet_id(self) -> Optional[str]:
   207â†’        """Get specific subnet ID."""
   208â†’        return self.data.get("aws", {}).get("subnet_id")
   209â†’    
   210â†’    def associate_public_ip(self) -> bool:
   211â†’        """Check if instances should have public IP."""
   212â†’        return self.data.get("aws", {}).get("associate_public_ip", True)
   213â†’    
   214â†’    def tags(self) -> Dict[str, str]:
   215â†’        """Get additional tags for instances."""
   216â†’        return self.data.get("aws", {}).get("tags", {})
   217â†’    
   218â†’    def region_config(self, region: str) -> Dict:
   219â†’        """Get config for specific region."""
   220â†’        for r in self.data.get("regions", []):
   221â†’            if region in r:
   222â†’                return r[region]
   223â†’        return {"machine_type": "t3.medium", "image": "auto"}
   224â†’
   225â†’# =============================================================================
   226â†’# SIMPLE CACHE UTILITIES  
   227â†’# =============================================================================
   228â†’
   229â†’def cache_file_fresh(filepath: str, max_age_hours: int = 24) -> bool:
   230â†’    """Check if cache file is fresh."""
   231â†’    if not os.path.exists(filepath):
   232â†’        return False
   233â†’    age_hours = (time.time() - os.path.getmtime(filepath)) / 3600
   234â†’    return age_hours < max_age_hours
   235â†’
   236â†’def load_cache(filepath: str) -> Optional[Dict]:
   237â†’    """Load data from cache file."""
   238â†’    if cache_file_fresh(filepath):
   239â†’        try:
   240â†’            with open(filepath, 'r') as f:
   241â†’                return json.load(f)
   242â†’        except Exception:
   243â†’            pass
   244â†’    return None
   245â†’
   246â†’def save_cache(filepath: str, data: Dict) -> None:
   247â†’    """Save data to cache file."""
   248â†’    try:
   249â†’        os.makedirs(os.path.dirname(filepath), exist_ok=True)
   250â†’        with open(filepath, 'w') as f:
   251â†’            json.dump(data, f, indent=2, default=str)
   252â†’    except Exception:
   253â†’        pass
   254â†’
   255â†’# =============================================================================
   256â†’# SIMPLE STATE MANAGEMENT
   257â†’# =============================================================================
   258â†’
   259â†’class SimpleStateManager:
   260â†’    """Simple JSON-based state management - replaces SQLite complexity."""
   261â†’    
   262â†’    def __init__(self, state_file: str = "instances.json"):
   263â†’        self.state_file = state_file
   264â†’    
   265â†’    def load_instances(self) -> List[Dict]:
   266â†’        """Load instances from JSON file."""
   267â†’        try:
   268â†’            with open(self.state_file, 'r') as f:
   269â†’                data = json.load(f)
   270â†’                return data.get("instances", [])
   271â†’        except FileNotFoundError:
   272â†’            return []
   273â†’        except Exception as e:
   274â†’            print(f"Error loading state: {e}")
   275â†’            return []
   276â†’    
   277â†’    def save_instances(self, instances: List[Dict]) -> None:
   278â†’        """Save instances to JSON file."""
   279â†’        try:
   280â†’            data = {
   281â†’                "instances": instances,
   282â†’                "last_updated": datetime.now().isoformat()
   283â†’            }
   284â†’            with open(self.state_file, 'w') as f:
   285â†’                json.dump(data, f, indent=2, default=str)
   286â†’        except Exception as e:
   287â†’            print(f"Error saving state: {e}")
   288â†’    
   289â†’    def add_instance(self, instance: Dict) -> None:
   290â†’        """Add instance to state."""
   291â†’        instances = self.load_instances()
   292â†’        instances.append(instance)
   293â†’        self.save_instances(instances)
   294â†’    
   295â†’    def remove_instances_by_region(self, region: str) -> int:
   296â†’        """Remove instances from specific region."""
   297â†’        instances = self.load_instances()
   298â†’        original_count = len(instances)
   299â†’        instances = [i for i in instances if i.get("region") != region]
   300â†’        self.save_instances(instances)
   301â†’        return original_count - len(instances)
   302â†’
   303â†’# =============================================================================
   304â†’# AWS UTILITIES
   305â†’# =============================================================================
   306â†’
   307â†’def get_latest_ubuntu_ami(region: str, log_function=None) -> Optional[str]:
   308â†’    """Get latest Ubuntu 22.04 LTS AMI for region."""
   309â†’    cache_file = f".aws_cache/ami_{region}.json"
   310â†’    
   311â†’    def log_message(msg: str):
   312â†’        if log_function:
   313â†’            log_function(msg)
   314â†’        else:
   315â†’            print(msg)
   316â†’    
   317â†’    # Try cache first
   318â†’    cached = load_cache(cache_file)
   319â†’    if cached and "ami_id" in cached:
   320â†’        log_message(f"Using cached AMI for {region}: {cached['ami_id']}")
   321â†’        return cached["ami_id"]
   322â†’    
   323â†’    # Fetch from AWS
   324â†’    try:
   325â†’        log_message(f"Fetching AMI for {region}...")
   326â†’        ec2 = boto3.client("ec2", region_name=region)
   327â†’        response = ec2.describe_images(
   328â†’            Owners=["099720109477"],  # Canonical
   329â†’            Filters=[
   330â†’                {"Name": "name", "Values": ["ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"]},
   331â†’                {"Name": "state", "Values": ["available"]},
   332â†’            ]
   333â†’            # Remove MaxResults - it seems to cause issues
   334â†’        )
   335â†’        
   336â†’        log_message(f"AMI response for {region}: {len(response.get('Images', []))} images found")
   337â†’        
   338â†’        if response["Images"]:
   339â†’            # Sort by creation date to get latest
   340â†’            images = sorted(response["Images"], key=lambda x: x["CreationDate"], reverse=True)
   341â†’            ami_id = images[0]["ImageId"]
   342â†’            log_message(f"Found AMI for {region}: {ami_id}")
   343â†’            # Cache result
   344â†’            save_cache(cache_file, {"ami_id": ami_id, "timestamp": datetime.now().isoformat()})
   345â†’            return ami_id
   346â†’        else:
   347â†’            log_message(f"No Ubuntu AMIs found for {region}")
   348â†’    except Exception as e:
   349â†’        log_message(f"Error getting AMI for {region}: {e}")
   350â†’    
   351â†’    return None
   352â†’
   353â†’def check_aws_auth() -> bool:
   354â†’    """Quick AWS authentication check."""
   355â†’    try:
   356â†’        sts = boto3.client("sts")
   357â†’        sts.get_caller_identity()
   358â†’        return True
   359â†’    except Exception as e:
   360â†’        if "token has expired" in str(e).lower():
   361â†’            rich_error("AWS credentials expired. Run: aws sso login")
   362â†’        else:
   363â†’            rich_error(f"AWS authentication failed: {e}")
   364â†’        return False
   365â†’
   366â†’# =============================================================================
   367â†’# FILE AND SCRIPT HANDLING
   368â†’# =============================================================================
   369â†’
   370â†’def generate_minimal_cloud_init(config: SimpleConfig) -> str:
   371â†’    """Generate minimal cloud-init script for basic setup only."""
   372â†’    # Get public SSH key content
   373â†’    public_key = config.public_ssh_key_content()
   374â†’    if not public_key:
   375â†’        rich_warning("No public SSH key found - SSH access may not work")
   376â†’        public_key = ""
   377â†’    
   378â†’    # Create minimal cloud-init script
   379â†’    cloud_init_script = f"""#cloud-config
   380â†’
   381â†’users:
   382â†’  - name: {config.username()}
   383â†’    sudo: ALL=(ALL) NOPASSWD:ALL
   384â†’    shell: /bin/bash
   385â†’    ssh_authorized_keys:
   386â†’      - {public_key}
   387â†’    groups: docker
   388â†’
   389â†’package_update: true
   390â†’package_upgrade: true
   391â†’
   392â†’packages:
   393â†’  - curl
   394â†’  - wget
   395â†’  - unzip
   396â†’  - git
   397â†’  - python3
   398â†’  - python3-pip
   399â†’  - docker.io
   400â†’
   401â†’runcmd:
   402â†’  # Basic Docker setup
   403â†’  - systemctl enable docker
   404â†’  - systemctl start docker
   405â†’  - usermod -aG docker {config.username()}
   406â†’  
   407â†’  # Ensure SSH directory is properly set up
   408â†’  - mkdir -p /home/{config.username()}/.ssh
   409â†’  - echo "{public_key}" > /home/{config.username()}/.ssh/authorized_keys
   410â†’  - chown -R {config.username()}:{config.username()} /home/{config.username()}/.ssh
   411â†’  - chmod 700 /home/{config.username()}/.ssh
   412â†’  - chmod 600 /home/{config.username()}/.ssh/authorized_keys
   413â†’  
   414â†’  # Install uv for Python scripts
   415â†’  - curl -LsSf https://astral.sh/uv/install.sh | env UV_INSTALL_DIR="/usr/local/bin" sh
   416â†’  - chmod 755 /usr/local/bin/uv
   417â†’  
   418â†’  # Create directory for uploaded files
   419â†’  - mkdir -p /tmp/uploaded_files
   420â†’  - chown {config.username()}:{config.username()} /tmp/uploaded_files
   421â†’  
   422â†’  # Signal that instance is ready
   423â†’  - echo "Instance setup complete" > /tmp/setup_complete
   424â†’  - chown {config.username()}:{config.username()} /tmp/setup_complete
   425â†’
   426â†’power_state:
   427â†’  mode: reboot
   428â†’  timeout: 300
   429â†’  condition: True
   430â†’"""
   431â†’    
   432â†’    return cloud_init_script
   433â†’
   434â†’def wait_for_ssh_ready(hostname: str, username: str, private_key_path: str, timeout: int = 300) -> bool:
   435â†’    """Wait for SSH to be ready on the instance."""
   436â†’    start_time = time.time()
   437â†’    
   438â†’    while time.time() - start_time < timeout:
   439â†’        try:
   440â†’            # Test SSH connection
   441â†’            result = subprocess.run([
   442â†’                'ssh', '-i', private_key_path,
   443â†’                '-o', 'StrictHostKeyChecking=no',
   444â†’                '-o', 'UserKnownHostsFile=/dev/null',
   445â†’                '-o', 'ConnectTimeout=5',
   446â†’                f'{username}@{hostname}',
   447â†’                'echo "SSH ready"'
   448â†’            ], capture_output=True, text=True, timeout=10)
   449â†’            
   450â†’            if result.returncode == 0:
   451â†’                return True
   452â†’                
   453â†’        except subprocess.TimeoutExpired:
   454â†’            pass
   455â†’        except Exception:
   456â†’            pass
   457â†’        
   458â†’        time.sleep(10)
   459â†’    
   460â†’    return False
   461â†’
   462â†’def upload_files_to_instance(hostname: str, username: str, private_key_path: str, config: SimpleConfig) -> bool:
   463â†’    """Upload files and scripts to the instance."""
   464â†’    try:
   465â†’        # Upload files directory if it exists
   466â†’        files_dir = config.files_directory()
   467â†’        if os.path.exists(files_dir):
   468â†’            rich_status(f"Uploading files from {files_dir}...")
   469â†’            result = subprocess.run([
   470â†’                'scp', '-i', private_key_path,
   471â†’                '-o', 'StrictHostKeyChecking=no',
   472â†’                '-o', 'UserKnownHostsFile=/dev/null',
   473â†’                '-r', files_dir,
   474â†’                f'{username}@{hostname}:/tmp/uploaded_files/'
   475â†’            ], capture_output=True, text=True)
   476â†’            
   477â†’            if result.returncode != 0:
   478â†’                rich_error(f"Failed to upload files: {result.stderr}")
   479â†’                return False
   480â†’        
   481â†’        # Upload scripts directory if it exists
   482â†’        scripts_dir = config.scripts_directory()
   483â†’        if os.path.exists(scripts_dir):
   484â†’            rich_status(f"Uploading scripts from {scripts_dir}...")
   485â†’            result = subprocess.run([
   486â†’                'scp', '-i', private_key_path,
   487â†’                '-o', 'StrictHostKeyChecking=no',
   488â†’                '-o', 'UserKnownHostsFile=/dev/null',
   489â†’                '-r', scripts_dir,
   490â†’                f'{username}@{hostname}:/tmp/uploaded_files/'
   491â†’            ], capture_output=True, text=True)
   492â†’            
   493â†’            if result.returncode != 0:
   494â†’                rich_error(f"Failed to upload scripts: {result.stderr}")
   495â†’                return False
   496â†’        
   497â†’        # Upload Bacalhau config if it exists
   498â†’        bacalhau_config_path = config.bacalhau_config_template()
   499â†’        if os.path.exists(bacalhau_config_path):
   500â†’            rich_status(f"Uploading Bacalhau config...")
   501â†’            result = subprocess.run([
   502â†’                'scp', '-i', private_key_path,
   503â†’                '-o', 'StrictHostKeyChecking=no',
   504â†’                '-o', 'UserKnownHostsFile=/dev/null',
   505â†’                bacalhau_config_path,
   506â†’                f'{username}@{hostname}:/tmp/uploaded_files/bacalhau_config.yaml'
   507â†’            ], capture_output=True, text=True)
   508â†’            
   509â†’            if result.returncode != 0:
   510â†’                rich_error(f"Failed to upload Bacalhau config: {result.stderr}")
   511â†’                return False
   512â†’        
   513â†’        return True
   514â†’        
   515â†’    except Exception as e:
   516â†’        rich_error(f"Error uploading files: {e}")
   517â†’        return False
   518â†’
   519â†’def execute_startup_script(hostname: str, username: str, private_key_path: str, config: SimpleConfig) -> bool:
   520â†’    """Execute the startup script on the instance."""
   521â†’    try:
   522â†’        startup_script = config.startup_script()
   523â†’        
   524â†’        if not os.path.exists(startup_script):
   525â†’            rich_warning(f"Startup script {startup_script} not found")
   526â†’            return True  # Not an error if no startup script
   527â†’        
   528â†’        rich_status(f"Executing startup script...")
   529â†’        
   530â†’        # First, upload the startup script
   531â†’        result = subprocess.run([
   532â†’            'scp', '-i', private_key_path,
   533â†’            '-o', 'StrictHostKeyChecking=no',
   534â†’            '-o', 'UserKnownHostsFile=/dev/null',
   535â†’            startup_script,
   536â†’            f'{username}@{hostname}:/tmp/startup_script.py'
   537â†’        ], capture_output=True, text=True)
   538â†’        
   539â†’        if result.returncode != 0:
   540â†’            rich_error(f"Failed to upload startup script: {result.stderr}")
   541â†’            return False
   542â†’        
   543â†’        # Execute the startup script
   544â†’        result = subprocess.run([
   545â†’            'ssh', '-i', private_key_path,
   546â†’            '-o', 'StrictHostKeyChecking=no',
   547â†’            '-o', 'UserKnownHostsFile=/dev/null',
   548â†’            f'{username}@{hostname}',
   549â†’            'chmod +x /tmp/startup_script.py && cd /tmp/uploaded_files && python3 /tmp/startup_script.py'
   550â†’        ], capture_output=True, text=True, timeout=600)  # 10 minute timeout
   551â†’        
   552â†’        if result.returncode != 0:
   553â†’            rich_error(f"Startup script failed: {result.stderr}")
   554â†’            return False
   555â†’        
   556â†’        rich_success("Startup script executed successfully")
   557â†’        return True
   558â†’        
   559â†’    except subprocess.TimeoutExpired:
   560â†’        rich_error("Startup script execution timed out")
   561â†’        return False
   562â†’    except Exception as e:
   563â†’        rich_error(f"Error executing startup script: {e}")
   564â†’        return False
   565â†’
   566â†’def execute_additional_commands(hostname: str, username: str, private_key_path: str, config: SimpleConfig) -> bool:
   567â†’    """Execute additional commands script if configured."""
   568â†’    try:
   569â†’        additional_script = config.additional_commands_script()
   570â†’        
   571â†’        if not additional_script or not os.path.exists(additional_script):
   572â†’            return True  # Not an error if no additional commands
   573â†’        
   574â†’        rich_status(f"Executing additional commands...")
   575â†’        
   576â†’        # Upload and execute additional commands script
   577â†’        result = subprocess.run([
   578â†’            'scp', '-i', private_key_path,
   579â†’            '-o', 'StrictHostKeyChecking=no',
   580â†’            '-o', 'UserKnownHostsFile=/dev/null',
   581â†’            additional_script,
   582â†’            f'{username}@{hostname}:/tmp/additional_commands.sh'
   583â†’        ], capture_output=True, text=True)
   584â†’        
   585â†’        if result.returncode != 0:
   586â†’            rich_error(f"Failed to upload additional commands: {result.stderr}")
   587â†’            return False
   588â†’        
   589â†’        # Execute additional commands
   590â†’        result = subprocess.run([
   591â†’            'ssh', '-i', private_key_path,
   592â†’            '-o', 'StrictHostKeyChecking=no',
   593â†’            '-o', 'UserKnownHostsFile=/dev/null',
   594â†’            f'{username}@{hostname}',
   595â†’            'chmod +x /tmp/additional_commands.sh && /tmp/additional_commands.sh'
   596â†’        ], capture_output=True, text=True, timeout=300)  # 5 minute timeout
   597â†’        
   598â†’        if result.returncode != 0:
   599â†’            rich_error(f"Additional commands failed: {result.stderr}")
   600â†’            return False
   601â†’        
   602â†’        rich_success("Additional commands executed successfully")
   603â†’        return True
   604â†’        
   605â†’    except subprocess.TimeoutExpired:
   606â†’        rich_error("Additional commands execution timed out")
   607â†’        return False
   608â†’    except Exception as e:
   609â†’        rich_error(f"Error executing additional commands: {e}")
   610â†’        return False
   611â†’
   612â†’# =============================================================================
   613â†’# CORE SPOT INSTANCE MANAGEMENT
   614â†’# =============================================================================
   615â†’
   616â†’def create_simple_security_group(ec2, vpc_id: str) -> str:
   617â†’    """Create basic security group."""
   618â†’    try:
   619â†’        # Check for existing security group
   620â†’        response = ec2.describe_security_groups(
   621â†’            Filters=[
   622â†’                {"Name": "vpc-id", "Values": [vpc_id]},
   623â†’                {"Name": "group-name", "Values": ["spot-deployer-sg"]},
   624â†’            ]
   625â†’        )
   626â†’        
   627â†’        if response["SecurityGroups"]:
   628â†’            return response["SecurityGroups"][0]["GroupId"]
   629â†’        
   630â†’        # Create new security group
   631â†’        response = ec2.create_security_group(
   632â†’            GroupName="spot-deployer-sg",
   633â†’            Description="Simple security group for spot instances",
   634â†’            VpcId=vpc_id
   635â†’        )
   636â†’        sg_id = response["GroupId"]
   637â†’        
   638â†’        # Add basic rules
   639â†’        ec2.authorize_security_group_ingress(
   640â†’            GroupId=sg_id,
   641â†’            IpPermissions=[
   642â†’                {
   643â†’                    "IpProtocol": "tcp",
   644â†’                    "FromPort": 22,
   645â†’                    "ToPort": 22,
   646â†’                    "IpRanges": [{"CidrIp": "0.0.0.0/0"}],
   647â†’                },
   648â†’                {
   649â†’                    "IpProtocol": "tcp", 
   650â†’                    "FromPort": 4222,
   651â†’                    "ToPort": 4222,
   652â†’                    "IpRanges": [{"CidrIp": "0.0.0.0/0"}],
   653â†’                },
   654â†’            ]
   655â†’        )
   656â†’        
   657â†’        return sg_id
   658â†’    except Exception as e:
   659â†’        print(f"Error creating security group: {e}")
   660â†’        raise
   661â†’
   662â†’def create_instances_in_region(config: SimpleConfig, region: str, count: int, progress=None, task=None) -> List[Dict]:
   663â†’    """Create spot instances in a specific region."""
   664â†’    if count <= 0:
   665â†’        return []
   666â†’    
   667â†’    def update_progress(message: str):
   668â†’        """Update progress bar if available, otherwise use rich_status."""
   669â†’        if progress and task is not None:
   670â†’            progress.update(task, description=message)
   671â†’            time.sleep(0.2)  # Brief pause to show progress
   672â†’        else:
   673â†’            rich_status(message)
   674â†’    
   675â†’    update_progress(f"ðŸ” Looking for VPC in {region}...")
   676â†’    
   677â†’    try:
   678â†’        ec2 = boto3.client("ec2", region_name=region)
   679â†’        
   680â†’        # Get default VPC
   681â†’        vpcs = ec2.describe_vpcs(Filters=[{"Name": "is-default", "Values": ["true"]}])
   682â†’        if not vpcs["Vpcs"]:
   683â†’            update_progress(f"ðŸ” No default VPC in {region}, checking all VPCs...")
   684â†’            # Try any VPC if no default exists
   685â†’            all_vpcs = ec2.describe_vpcs()
   686â†’            if all_vpcs["Vpcs"]:
   687â†’                vpc_id = all_vpcs["Vpcs"][0]["VpcId"]
   688â†’                update_progress(f"ðŸ—ï¸  Using VPC {vpc_id} in {region}")
   689â†’            else:
   690â†’                rich_warning(f"No VPCs found in {region}, skipping")
   691â†’                return []
   692â†’        else:
   693â†’            vpc_id = vpcs["Vpcs"][0]["VpcId"]
   694â†’            update_progress(f"ðŸ—ï¸  Using default VPC {vpc_id} in {region}")
   695â†’        
   696â†’        # Get default subnet
   697â†’        update_progress(f"ðŸ” Looking for subnet in VPC {vpc_id}...")
   698â†’        subnets = ec2.describe_subnets(
   699â†’            Filters=[
   700â†’                {"Name": "vpc-id", "Values": [vpc_id]},
   701â†’                {"Name": "default-for-az", "Values": ["true"]},
   702â†’            ]
   703â†’        )
   704â†’        if not subnets["Subnets"]:
   705â†’            update_progress(f"ðŸ” No default subnet in {region}, trying any subnet...")
   706â†’            # Try any subnet in the VPC
   707â†’            all_subnets = ec2.describe_subnets(
   708â†’                Filters=[{"Name": "vpc-id", "Values": [vpc_id]}]
   709â†’            )
   710â†’            if all_subnets["Subnets"]:
   711â†’                subnet_id = all_subnets["Subnets"][0]["SubnetId"]
   712â†’                update_progress(f"ðŸŒ Using subnet {subnet_id} in {region}")
   713â†’            else:
   714â†’                rich_warning(f"No subnets found in VPC {vpc_id}, skipping")
   715â†’                return []
   716â†’        else:
   717â†’            subnet_id = subnets["Subnets"][0]["SubnetId"]
   718â†’            update_progress(f"ðŸŒ Using default subnet {subnet_id} in {region}")
   719â†’        
   720â†’        # Create security group
   721â†’        update_progress(f"ðŸ”’ Creating security group in {region}...")
   722â†’        sg_id = create_simple_security_group(ec2, vpc_id)
   723â†’        
   724â†’        # Get AMI
   725â†’        update_progress(f"ðŸ“€ Getting AMI for {region}...")
   726â†’        ami_id = get_latest_ubuntu_ami(region)
   727â†’        if not ami_id:
   728â†’            rich_warning(f"No AMI found for {region}, skipping")
   729â†’            return []
   730â†’        
   731â†’        # Get instance type
   732â†’        region_config = config.region_config(region)
   733â†’        instance_type = region_config.get("machine_type", "t3.medium")
   734â†’        
   735â†’        # Create user data script
   736â†’        user_data = f"""#!/bin/bash
   737â†’apt-get update
   738â†’apt-get install -y docker.io
   739â†’systemctl enable docker
   740â†’systemctl start docker
   741â†’usermod -aG docker {config.username()}
   742â†’"""
   743â†’        
   744â†’        # Create spot instance request
   745â†’        update_progress(f"ðŸš€ Requesting spot instances in {region}...")
   746â†’        spot_request = {
   747â†’            "ImageId": ami_id,
   748â†’            "InstanceType": instance_type,
   749â†’            "SecurityGroupIds": [sg_id],
   750â†’            "SubnetId": subnet_id,
   751â†’            "UserData": base64.b64encode(user_data.encode()).decode(),
   752â†’        }
   753â†’        
   754â†’        # Add SSH key if configured
   755â†’        ssh_key = config.ssh_key_name()
   756â†’        if ssh_key:
   757â†’            spot_request["KeyName"] = ssh_key
   758â†’        
   759â†’        # Request spot instances
   760â†’        response = ec2.request_spot_instances(
   761â†’            InstanceCount=count,
   762â†’            LaunchSpecification=spot_request,
   763â†’            Type="one-time"
   764â†’        )
   765â†’        
   766â†’        spot_request_ids = [req["SpotInstanceRequestId"] for req in response["SpotInstanceRequests"]]
   767â†’        update_progress(f"â³ Waiting for spot instances to launch in {region}...")
   768â†’        
   769â†’        # Wait for fulfillment (simplified - max 5 minutes)
   770â†’        instances = []
   771â†’        for attempt in range(30):  # 30 * 10s = 5 minutes max
   772â†’            try:
   773â†’                spot_response = ec2.describe_spot_instance_requests(SpotInstanceRequestIds=spot_request_ids)
   774â†’                
   775â†’                active_requests = [
   776â†’                    req for req in spot_response["SpotInstanceRequests"]
   777â†’                    if req["State"] == "active" and "InstanceId" in req
   778â†’                ]
   779â†’                
   780â†’                if len(active_requests) == count:
   781â†’                    update_progress(f"ðŸ·ï¸  Tagging instances in {region}...")
   782â†’                    # Get instance details
   783â†’                    instance_ids = [req["InstanceId"] for req in active_requests]
   784â†’                    instance_response = ec2.describe_instances(InstanceIds=instance_ids)
   785â†’                    
   786â†’                    for reservation in instance_response["Reservations"]:
   787â†’                        for instance in reservation["Instances"]:
   788â†’                            instances.append({
   789â†’                                "id": instance["InstanceId"],
   790â†’                                "region": region,
   791â†’                                "type": instance["InstanceType"],
   792â†’                                "state": instance["State"]["Name"],
   793â†’                                "public_ip": instance.get("PublicIpAddress", ""),
   794â†’                                "private_ip": instance.get("PrivateIpAddress", ""),
   795â†’                                "created": datetime.now().isoformat(),
   796â†’                            })
   797â†’                    
   798â†’                    # Tag instances
   799â†’                    if instance_ids:
   800â†’                        ec2.create_tags(
   801â†’                            Resources=instance_ids,
   802â†’                            Tags=[
   803â†’                                {"Key": "ManagedBy", "Value": "SpotDeployer"},
   804â†’                                {"Key": "Name", "Value": f"SpotInstance-{region}"},
   805â†’                            ]
   806â†’                        )
   807â†’                    
   808â†’                    break
   809â†’                
   810â†’                # Check for failed requests
   811â†’                failed = [req for req in spot_response["SpotInstanceRequests"] if req["State"] in ["failed", "cancelled"]]
   812â†’                if failed:
   813â†’                    rich_error(f"Some spot requests failed in {region}")
   814â†’                    break
   815â†’                
   816â†’                # Update progress with wait time
   817â†’                update_progress(f"â³ Waiting for spot instances to launch in {region}... (attempt {attempt + 1}/30)")
   818â†’                time.sleep(10)
   819â†’                
   820â†’            except Exception as e:
   821â†’                rich_error(f"Error checking spot requests: {e}")
   822â†’                break
   823â†’        
   824â†’        if not instances:
   825â†’            rich_warning(f"No instances created in {region} (timeout or failure)")
   826â†’        
   827â†’        return instances
   828â†’        
   829â†’    except Exception as e:
   830â†’        rich_error(f"Error creating instances in {region}: {e}")
   831â†’        return []
   832â†’
   833â†’def create_instances_in_region_with_table(config: SimpleConfig, region: str, count: int, creation_status: Dict, log_collector=None, lock=None, live_obj=None, layout_generator=None) -> List[Dict]:
   834â†’    """Create spot instances in a specific region with live table updates."""
   835â†’    if count <= 0:
   836â†’        return []
   837â†’    
   838â†’    def update_status(instance_key: str, status: str, instance_id: str = None, ip: str = None, created: str = None):
   839â†’        """Update the status in the live table."""
   840â†’        # Sanitize status to remove carriage returns and newlines
   841â†’        status = status.replace('\r', ' ').replace('\n', ' ').strip()
   842â†’        
   843â†’        if lock:
   844â†’            with lock:
   845â†’                if instance_key in creation_status:
   846â†’                    creation_status[instance_key]["status"] = status
   847â†’                    if instance_id:
   848â†’                        creation_status[instance_key]["instance_id"] = instance_id
   849â†’                    if ip:
   850â†’                        creation_status[instance_key]["public_ip"] = ip
   851â†’                    if created:
   852â†’                        creation_status[instance_key]["created"] = created
   853â†’                # Update live display if available
   854â†’                if live_obj and layout_generator:
   855â†’                    live_obj.update(layout_generator())
   856â†’        else:
   857â†’            if instance_key in creation_status:
   858â†’                creation_status[instance_key]["status"] = status
   859â†’                if instance_id:
   860â†’                    creation_status[instance_key]["instance_id"] = instance_id
   861â†’                if ip:
   862â†’                    creation_status[instance_key]["public_ip"] = ip
   863â†’                if created:
   864â†’                    creation_status[instance_key]["created"] = created
   865â†’            # Update live display if available
   866â†’            if live_obj and layout_generator:
   867â†’                live_obj.update(layout_generator())
   868â†’    
   869â†’    def log_message(msg: str):
   870â†’        """Thread-safe logging."""
   871â†’        if log_collector is not None:
   872â†’            if lock:
   873â†’                with lock:
   874â†’                    log_collector.append(msg)
   875â†’            else:
   876â†’                log_collector.append(msg)
   877â†’    
   878â†’    # Update all instance keys for this region
   879â†’    instance_keys = [f"{region}-{i+1}" for i in range(count)]
   880â†’    
   881â†’    # Update all instances in this region to show they're starting
   882â†’    for instance_key in instance_keys:
   883â†’        update_status(instance_key, "ðŸ” Looking for VPC...")
   884â†’    
   885â†’    try:
   886â†’        ec2 = boto3.client("ec2", region_name=region)
   887â†’        
   888â†’        # Get default VPC
   889â†’        log_message(f"[{region}] Looking for VPC...")
   890â†’        time.sleep(0.2)
   891â†’        vpcs = ec2.describe_vpcs(Filters=[{"Name": "is-default", "Values": ["true"]}])
   892â†’        if not vpcs["Vpcs"]:
   893â†’            for instance_key in instance_keys:
   894â†’                update_status(instance_key, "ðŸ” No default VPC, checking all VPCs...")
   895â†’            log_message(f"[{region}] No default VPC, checking all VPCs...")
   896â†’            time.sleep(0.2)
   897â†’            all_vpcs = ec2.describe_vpcs()
   898â†’            if all_vpcs["Vpcs"]:
   899â†’                vpc_id = all_vpcs["Vpcs"][0]["VpcId"]
   900â†’                for instance_key in instance_keys:
   901â†’                    update_status(instance_key, f"ðŸ—ï¸ Using VPC {vpc_id}")
   902â†’                log_message(f"[{region}] Using VPC {vpc_id}")
   903â†’            else:
   904â†’                for instance_key in instance_keys:
   905â†’                    update_status(instance_key, "âŒ No VPCs found")
   906â†’                log_message(f"[{region}] âŒ No VPCs found")
   907â†’                return []
   908â†’        else:
   909â†’            vpc_id = vpcs["Vpcs"][0]["VpcId"]
   910â†’            for instance_key in instance_keys:
   911â†’                update_status(instance_key, f"ðŸ—ï¸ Using default VPC {vpc_id}")
   912â†’            log_message(f"[{region}] Using default VPC {vpc_id}")
   913â†’        
   914â†’        time.sleep(0.2)
   915â†’        
   916â†’        # Get default subnet
   917â†’        for instance_key in instance_keys:
   918â†’            update_status(instance_key, "ðŸ” Looking for subnet...")
   919â†’        time.sleep(0.5)
   920â†’        subnets = ec2.describe_subnets(
   921â†’            Filters=[
   922â†’                {"Name": "vpc-id", "Values": [vpc_id]},
   923â†’                {"Name": "default-for-az", "Values": ["true"]},
   924â†’            ]
   925â†’        )
   926â†’        if not subnets["Subnets"]:
   927â†’            for instance_key in instance_keys:
   928â†’                update_status(instance_key, "ðŸ” No default subnet, trying any...")
   929â†’            time.sleep(0.5)
   930â†’            all_subnets = ec2.describe_subnets(
   931â†’                Filters=[{"Name": "vpc-id", "Values": [vpc_id]}]
   932â†’            )
   933â†’            if all_subnets["Subnets"]:
   934â†’                subnet_id = all_subnets["Subnets"][0]["SubnetId"]
   935â†’                for instance_key in instance_keys:
   936â†’                    update_status(instance_key, f"ðŸŒ Using subnet {subnet_id}")
   937â†’            else:
   938â†’                for instance_key in instance_keys:
   939â†’                    update_status(instance_key, "âŒ No subnets found")
   940â†’                return []
   941â†’        else:
   942â†’            subnet_id = subnets["Subnets"][0]["SubnetId"]
   943â†’            for instance_key in instance_keys:
   944â†’                update_status(instance_key, f"ðŸŒ Using default subnet {subnet_id}")
   945â†’        
   946â†’        time.sleep(0.5)
   947â†’        
   948â†’        # Create security group
   949â†’        for instance_key in instance_keys:
   950â†’            update_status(instance_key, "ðŸ”’ Creating security group...")
   951â†’        log_message(f"[{region}] Creating security group...")
   952â†’        time.sleep(0.2)
   953â†’        sg_id = create_simple_security_group(ec2, vpc_id)
   954â†’        
   955â†’        # Get AMI
   956â†’        for instance_key in instance_keys:
   957â†’            update_status(instance_key, "ðŸ“€ Getting AMI...")
   958â†’        log_message(f"[{region}] Getting AMI...")
   959â†’        time.sleep(0.2)
   960â†’        ami_id = get_latest_ubuntu_ami(region, log_message)
   961â†’        if not ami_id:
   962â†’            for instance_key in instance_keys:
   963â†’                update_status(instance_key, "âŒ No AMI found")
   964â†’            log_message(f"[{region}] âŒ No AMI found")
   965â†’            return []
   966â†’        
   967â†’        # Get instance type
   968â†’        region_config = config.region_config(region)
   969â†’        instance_type = region_config.get("machine_type", "t3.medium")
   970â†’        for instance_key in instance_keys:
   971â†’            creation_status[instance_key]["type"] = instance_type
   972â†’        
   973â†’        # Generate minimal cloud-init script
   974â†’        log_message(f"[{region}] Generating minimal cloud-init script...")
   975â†’        user_data = generate_minimal_cloud_init(config)
   976â†’        
   977â†’        # Create spot instance request
   978â†’        for instance_key in instance_keys:
   979â†’            update_status(instance_key, f"ðŸš€ Requesting spot instance...")
   980â†’        log_message(f"[{region}] Requesting {count} spot instance(s)...")
   981â†’        time.sleep(0.2)
   982â†’        
   983â†’        # Build security groups list
   984â†’        security_groups = [sg_id]
   985â†’        additional_sgs = config.security_groups()
   986â†’        if additional_sgs:
   987â†’            security_groups.extend(additional_sgs)
   988â†’        
   989â†’        # Build block device mappings for storage (commented out to test)
   990â†’        # block_device_mappings = [
   991â†’        #     {
   992â†’        #         "DeviceName": "/dev/sda1",
   993â†’        #         "Ebs": {
   994â†’        #             "VolumeSize": config.instance_storage_gb(),
   995â†’        #             "VolumeType": "gp3",
   996â†’        #             "DeleteOnTermination": True
   997â†’        #         }
   998â†’        #     }
   999â†’        # ]
  1000â†’        
  1001â†’        spot_request = {
  1002â†’            "ImageId": ami_id,
  1003â†’            "InstanceType": instance_type,
  1004â†’            "SecurityGroupIds": security_groups,
  1005â†’            "SubnetId": subnet_id,
  1006â†’            "UserData": base64.b64encode(user_data.encode()).decode(),
  1007â†’            # "BlockDeviceMappings": block_device_mappings,
  1008â†’        }
  1009â†’        
  1010â†’        # Add SSH key if configured
  1011â†’        ssh_key = config.ssh_key_name()
  1012â†’        if ssh_key:
  1013â†’            spot_request["KeyName"] = ssh_key
  1014â†’        
  1015â†’        # Add associate public IP if configured (commented out to test)
  1016â†’        # if config.associate_public_ip():
  1017â†’        #     spot_request["AssociatePublicIpAddress"] = True
  1018â†’        
  1019â†’        # Build spot instance request parameters
  1020â†’        spot_params = {
  1021â†’            "InstanceCount": count,
  1022â†’            "LaunchSpecification": spot_request,
  1023â†’            "Type": "one-time"
  1024â†’        }
  1025â†’        
  1026â†’        # Add spot price if configured
  1027â†’        region_config = config.region_config(region)
  1028â†’        spot_price = region_config.get("spot_price_limit") or config.spot_price_limit()
  1029â†’        if spot_price:
  1030â†’            spot_params["SpotPrice"] = str(spot_price)
  1031â†’        
  1032â†’        # Request spot instances
  1033â†’        response = ec2.request_spot_instances(**spot_params)
  1034â†’        
  1035â†’        spot_request_ids = [req["SpotInstanceRequestId"] for req in response["SpotInstanceRequests"]]
  1036â†’        for instance_key in instance_keys:
  1037â†’            update_status(instance_key, "â³ Waiting for spot instance to launch...")
  1038â†’        log_message(f"[{region}] Waiting for {count} spot instance(s) to launch...")
  1039â†’        
  1040â†’        # Wait for fulfillment (simplified - max 5 minutes)
  1041â†’        instances = []
  1042â†’        for attempt in range(30):  # 30 * 10s = 5 minutes max
  1043â†’            try:
  1044â†’                spot_response = ec2.describe_spot_instance_requests(SpotInstanceRequestIds=spot_request_ids)
  1045â†’                
  1046â†’                active_requests = [
  1047â†’                    req for req in spot_response["SpotInstanceRequests"]
  1048â†’                    if req["State"] == "active" and "InstanceId" in req
  1049â†’                ]
  1050â†’                
  1051â†’                if len(active_requests) == count:
  1052â†’                    for instance_key in instance_keys:
  1053â†’                        update_status(instance_key, "ðŸ·ï¸ Getting instance details...")
  1054â†’                    log_message(f"[{region}] Getting instance details...")
  1055â†’                    time.sleep(0.2)
  1056â†’                    # Get instance details
  1057â†’                    instance_ids = [req["InstanceId"] for req in active_requests]
  1058â†’                    instance_response = ec2.describe_instances(InstanceIds=instance_ids)
  1059â†’                    
  1060â†’                    instance_idx = 0
  1061â†’                    for reservation in instance_response["Reservations"]:
  1062â†’                        for instance in reservation["Instances"]:
  1063â†’                            instance_id = instance["InstanceId"]
  1064â†’                            public_ip = instance.get("PublicIpAddress", "pending...")
  1065â†’                            created_time = datetime.now().strftime('%m-%d %H:%M')
  1066â†’                            
  1067â†’                            instances.append({
  1068â†’                                "id": instance_id,
  1069â†’                                "region": region,
  1070â†’                                "type": instance["InstanceType"],
  1071â†’                                "state": instance["State"]["Name"],
  1072â†’                                "public_ip": public_ip,
  1073â†’                                "private_ip": instance.get("PrivateIpAddress", ""),
  1074â†’                                "created": datetime.now().isoformat(),
  1075â†’                            })
  1076â†’                            
  1077â†’                            # Update the corresponding instance key
  1078â†’                            if instance_idx < len(instance_keys):
  1079â†’                                update_status(instance_keys[instance_idx], "âœ… Instance created successfully", 
  1080â†’                                            instance_id, public_ip, created_time)
  1081â†’                                instance_idx += 1
  1082â†’                    
  1083â†’                    # Tag instances with comprehensive tags
  1084â†’                    if instance_ids:
  1085â†’                        # Build tag list
  1086â†’                        tags = [
  1087â†’                            {"Key": "ManagedBy", "Value": "SpotDeployer"},
  1088â†’                            {"Key": "Name", "Value": f"SpotInstance-{region}"},
  1089â†’                            {"Key": "Region", "Value": region},
  1090â†’                            {"Key": "CreatedBy", "Value": "AWS-Spot-Deployer"},
  1091â†’                            {"Key": "CreatedAt", "Value": datetime.now().strftime('%Y-%m-%d %H:%M:%S')},
  1092â†’                        ]
  1093â†’                        
  1094â†’                        # Add global tags from config
  1095â†’                        global_tags = config.tags()
  1096â†’                        for key, value in global_tags.items():
  1097â†’                            tags.append({"Key": key, "Value": value})
  1098â†’                        
  1099â†’                        # Add region-specific tags
  1100â†’                        region_tags = region_config.get("tags", {})
  1101â†’                        for key, value in region_tags.items():
  1102â†’                            tags.append({"Key": key, "Value": value})
  1103â†’                        
  1104â†’                        ec2.create_tags(Resources=instance_ids, Tags=tags)
  1105â†’                    
  1106â†’                    break
  1107â†’                
  1108â†’                # Check for failed requests
  1109â†’                failed = [req for req in spot_response["SpotInstanceRequests"] if req["State"] in ["failed", "cancelled"]]
  1110â†’                if failed:
  1111â†’                    for instance_key in instance_keys:
  1112â†’                        update_status(instance_key, "âŒ Spot request failed")
  1113â†’                    break
  1114â†’                
  1115â†’                # Update progress with wait time
  1116â†’                for instance_key in instance_keys:
  1117â†’                    update_status(instance_key, f"â³ Waiting for spot instance... (attempt {attempt + 1}/30)")
  1118â†’                time.sleep(10)
  1119â†’                
  1120â†’            except Exception as e:
  1121â†’                for instance_key in instance_keys:
  1122â†’                    update_status(instance_key, f"âŒ Error: {str(e)[:30]}...")
  1123â†’                break
  1124â†’        
  1125â†’        if not instances:
  1126â†’            for instance_key in instance_keys:
  1127â†’                update_status(instance_key, "âŒ No instances created (timeout)")
  1128â†’        
  1129â†’        return instances
  1130â†’        
  1131â†’    except Exception as e:
  1132â†’        for instance_key in instance_keys:
  1133â†’            update_status(instance_key, f"âŒ Error: {str(e)[:30]}...")
  1134â†’        return []
  1135â†’
  1136â†’# =============================================================================
  1137â†’# MAIN COMMANDS
  1138â†’# =============================================================================
  1139â†’
  1140â†’def cmd_create(config: SimpleConfig, state: SimpleStateManager) -> None:
  1141â†’    """Create spot instances across configured regions."""
  1142â†’    if not check_aws_auth():
  1143â†’        return
  1144â†’    
  1145â†’    regions = config.regions()
  1146â†’    total_count = config.instance_count()
  1147â†’    
  1148â†’    if not regions:
  1149â†’        rich_error("No regions configured. Run 'setup' first.")
  1150â†’        return
  1151â†’    
  1152â†’    instances_per_region = max(1, total_count // len(regions))
  1153â†’    
  1154â†’    if RICH_AVAILABLE and console:
  1155â†’        # Create log collector and status tracker
  1156â†’        log_messages = []
  1157â†’        creation_status = {}
  1158â†’        all_instances = []
  1159â†’        active_threads = []
  1160â†’        completed_count = 0
  1161â†’        
  1162â†’        # Support up to 10 instances max with better distribution
  1163â†’        max_instances = min(total_count, 10)
  1164â†’        instances_per_region = max(1, max_instances // len(regions))
  1165â†’        
  1166â†’        # Calculate remaining instances for the last region
  1167â†’        remaining_instances = max_instances % len(regions)
  1168â†’        
  1169â†’        # Initialize status for each instance
  1170â†’        instance_counter = 0
  1171â†’        for region_idx, region in enumerate(regions):
  1172â†’            instances_for_this_region = instances_per_region
  1173â†’            if region_idx == len(regions) - 1:  # Last region gets remaining instances
  1174â†’                instances_for_this_region += remaining_instances
  1175â†’            
  1176â†’            for i in range(instances_for_this_region):
  1177â†’                if instance_counter >= max_instances:
  1178â†’                    break
  1179â†’                key = f"{region}-{i+1}"
  1180â†’                creation_status[key] = {
  1181â†’                    "region": region,
  1182â†’                    "instance_id": "pending...",
  1183â†’                    "status": "â³ Waiting to start",
  1184â†’                    "type": "t3.medium",
  1185â†’                    "public_ip": "pending...",
  1186â†’                    "created": "pending..."
  1187â†’                }
  1188â†’                instance_counter += 1
  1189â†’        
  1190â†’        # Create thread-safe lock
  1191â†’        lock = threading.Lock()
  1192â†’        
  1193â†’        def generate_layout():
  1194â†’            # Create the table with fixed widths
  1195â†’            table = Table(title=f"Creating {len(creation_status)} instances across {len(regions)} regions", show_header=True, width=120)
  1196â†’            table.add_column("Region", style="magenta", width=12, no_wrap=True)
  1197â†’            table.add_column("Instance ID", style="cyan", width=20, no_wrap=True)
  1198â†’            table.add_column("Status", style="yellow", width=40, no_wrap=True)
  1199â†’            table.add_column("Type", style="green", width=12, no_wrap=True)
  1200â†’            table.add_column("Public IP", style="blue", width=16, no_wrap=True)
  1201â†’            table.add_column("Created", style="dim", width=12, no_wrap=True)
  1202â†’            
  1203â†’            # Sort: active work at top, completed at bottom
  1204â†’            sorted_items = sorted(creation_status.items(), key=lambda x: (
  1205â†’                0 if x[1]["status"].startswith("âœ…") else 1,  # Completed items last
  1206â†’                1 if x[1]["status"].startswith("âŒ") else 0,  # Failed items first
  1207â†’                2 if x[1]["status"].startswith("â³") else 0,  # Waiting items last
  1208â†’                x[0]  # Then by key
  1209â†’            ))
  1210â†’            
  1211â†’            for key, item in sorted_items:
  1212â†’                # Add status indicators and truncate if needed
  1213â†’                status = item["status"]
  1214â†’                if len(status) > 38:  # Leave room for styling
  1215â†’                    status = status[:35] + "..."
  1216â†’                
  1217â†’                if status.startswith("âœ…"):
  1218â†’                    status_style = "[bold green]" + status + "[/bold green]"
  1219â†’                elif status.startswith("âŒ"):
  1220â†’                    status_style = "[bold red]" + status + "[/bold red]"
  1221â†’                elif status.startswith("ðŸ”") or status.startswith("ðŸ—ï¸") or status.startswith("ðŸŒ"):
  1222â†’                    status_style = "[bold blue]" + status + "[/bold blue]"
  1223â†’                elif status.startswith("ðŸš€") or status.startswith("â³"):
  1224â†’                    status_style = "[bold yellow]" + status + "[/bold yellow]"
  1225â†’                else:
  1226â†’                    status_style = status
  1227â†’                
  1228â†’                # Truncate other fields if needed
  1229â†’                region = item["region"][:11] if len(item["region"]) > 11 else item["region"]
  1230â†’                instance_id = item["instance_id"][:19] if len(item["instance_id"]) > 19 else item["instance_id"]
  1231â†’                instance_type = item["type"][:11] if len(item["type"]) > 11 else item["type"]
  1232â†’                public_ip = item["public_ip"][:15] if len(item["public_ip"]) > 15 else item["public_ip"]
  1233â†’                created = item["created"][:11] if len(item["created"]) > 11 else item["created"]
  1234â†’                
  1235â†’                table.add_row(
  1236â†’                    region,
  1237â†’                    instance_id,
  1238â†’                    status_style,
  1239â†’                    instance_type,
  1240â†’                    public_ip,
  1241â†’                    created
  1242â†’                )
  1243â†’            
  1244â†’            # Create the log panel
  1245â†’            log_content = "\n".join(log_messages[-20:])  # Show last 20 log messages
  1246â†’            if not log_content.strip():
  1247â†’                log_content = "ðŸš€ Initializing..."
  1248â†’            
  1249â†’            log_panel = Panel(
  1250â†’                log_content,
  1251â†’                title=f"ðŸ“‹ Log Messages ({len(log_messages)} total)",
  1252â†’                border_style="blue",
  1253â†’                height=12
  1254â†’            )
  1255â†’            
  1256â†’            # Create layout
  1257â†’            layout = Layout()
  1258â†’            layout.split_column(
  1259â†’                Layout(table, name="table", ratio=2),
  1260â†’                Layout(log_panel, name="logs", ratio=1)
  1261â†’            )
  1262â†’            
  1263â†’            return layout
  1264â†’        
  1265â†’        def post_creation_setup(instances, config, creation_status, log_messages, lock, live_obj, generate_layout):
  1266â†’            """Handle post-creation setup: file uploads and script execution."""
  1267â†’            private_key_path = config.private_ssh_key_path()
  1268â†’            username = config.username()
  1269â†’            
  1270â†’            for instance in instances:
  1271â†’                instance_id = instance['id']
  1272â†’                hostname = instance.get('public_ip', instance.get('private_ip', ''))
  1273â†’                region = instance['region']
  1274â†’                
  1275â†’                # Find the instance key for status updates
  1276â†’                instance_key = None
  1277â†’                for key in creation_status.keys():
  1278â†’                    if key.startswith(f"{region}-"):
  1279â†’                        instance_key = key
  1280â†’                        break
  1281â†’                
  1282â†’                if not instance_key or not hostname:
  1283â†’                    continue
  1284â†’                
  1285â†’                try:
  1286â†’                    # Update status to waiting for SSH
  1287â†’                    def update_status(status):
  1288â†’                        if lock:
  1289â†’                            with lock:
  1290â†’                                creation_status[instance_key]["status"] = status
  1291â†’                                live_obj.update(generate_layout())
  1292â†’                        else:
  1293â†’                            creation_status[instance_key]["status"] = status
  1294â†’                            live_obj.update(generate_layout())
  1295â†’                    
  1296â†’                    def log_message(msg):
  1297â†’                        if lock:
  1298â†’                            with lock:
  1299â†’                                log_messages.append(msg)
  1300â†’                                live_obj.update(generate_layout())
  1301â†’                        else:
  1302â†’                            log_messages.append(msg)
  1303â†’                            live_obj.update(generate_layout())
  1304â†’                    
  1305â†’                    # Wait for SSH to be ready
  1306â†’                    update_status("â³ Waiting for SSH...")
  1307â†’                    log_message(f"[{region}] Waiting for SSH on {hostname}...")
  1308â†’                    
  1309â†’                    if not wait_for_ssh_ready(hostname, username, private_key_path, timeout=300):
  1310â†’                        update_status("âŒ SSH timeout")
  1311â†’                        log_message(f"[{region}] SSH timeout on {hostname}")
  1312â†’                        continue
  1313â†’                    
  1314â†’                    # Upload files
  1315â†’                    update_status("ðŸ“¤ Uploading files...")
  1316â†’                    log_message(f"[{region}] Uploading files to {hostname}...")
  1317â†’                    
  1318â†’                    if not upload_files_to_instance(hostname, username, private_key_path, config):
  1319â†’                        update_status("âŒ Upload failed")
  1320â†’                        log_message(f"[{region}] File upload failed on {hostname}")
  1321â†’                        continue
  1322â†’                    
  1323â†’                    # Execute startup script
  1324â†’                    update_status("ðŸš€ Running startup script...")
  1325â†’                    log_message(f"[{region}] Executing startup script on {hostname}...")
  1326â†’                    
  1327â†’                    if not execute_startup_script(hostname, username, private_key_path, config):
  1328â†’                        update_status("âŒ Startup script failed")
  1329â†’                        log_message(f"[{region}] Startup script failed on {hostname}")
  1330â†’                        continue
  1331â†’                    
  1332â†’                    # Execute additional commands
  1333â†’                    update_status("ðŸ”§ Running additional commands...")
  1334â†’                    log_message(f"[{region}] Executing additional commands on {hostname}...")
  1335â†’                    
  1336â†’                    if not execute_additional_commands(hostname, username, private_key_path, config):
  1337â†’                        update_status("âŒ Additional commands failed")
  1338â†’                        log_message(f"[{region}] Additional commands failed on {hostname}")
  1339â†’                        continue
  1340â†’                    
  1341â†’                    # Success
  1342â†’                    update_status("âœ… Setup complete")
  1343â†’                    log_message(f"[{region}] Setup completed successfully on {hostname}")
  1344â†’                    
  1345â†’                except Exception as e:
  1346â†’                    if instance_key:
  1347â†’                        if lock:
  1348â†’                            with lock:
  1349â†’                                creation_status[instance_key]["status"] = f"âŒ Setup error: {str(e)[:20]}..."
  1350â†’                                live_obj.update(generate_layout())
  1351â†’                        else:
  1352â†’                            creation_status[instance_key]["status"] = f"âŒ Setup error: {str(e)[:20]}..."
  1353â†’                            live_obj.update(generate_layout())
  1354â†’                    
  1355â†’                    log_message(f"[{region}] Setup error on {hostname}: {str(e)}")
  1356â†’
  1357â†’        def create_region_instances(region, instances_count, live_obj):
  1358â†’            """Thread function to create instances in a specific region."""
  1359â†’            try:
  1360â†’                with lock:
  1361â†’                    log_messages.append(f"ðŸš€ [{region}] Starting creation of {instances_count} instance(s)...")
  1362â†’                    live_obj.update(generate_layout())
  1363â†’                
  1364â†’                # Add a small delay to make the status update visible
  1365â†’                time.sleep(1)
  1366â†’                
  1367â†’                instances = create_instances_in_region_with_table(config, region, instances_count, creation_status, log_messages, lock, live_obj, generate_layout)
  1368â†’                
  1369â†’                with lock:
  1370â†’                    all_instances.extend(instances)
  1371â†’                    for instance in instances:
  1372â†’                        log_messages.append(f"âœ… [{region}] Instance {instance['id']} created successfully!")
  1373â†’                    live_obj.update(generate_layout())
  1374â†’                
  1375â†’                # Post-creation: Upload files and execute scripts
  1376â†’                if instances and config.private_ssh_key_path():
  1377â†’                    with lock:
  1378â†’                        log_messages.append(f"ðŸ”„ [{region}] Starting post-creation setup...")
  1379â†’                        live_obj.update(generate_layout())
  1380â†’                    
  1381â†’                    post_creation_setup(instances, config, creation_status, log_messages, lock, live_obj, generate_layout)
  1382â†’                        
  1383â†’            except Exception as e:
  1384â†’                with lock:
  1385â†’                    log_messages.append(f"âŒ [{region}] Error: {str(e)}")
  1386â†’                    live_obj.update(generate_layout())
  1387â†’        
  1388â†’        # Initialize log
  1389â†’        log_messages.append("ðŸš€ Starting instance creation process...")
  1390â†’        log_messages.append(f"ðŸ“Š Creating {len(creation_status)} instances across {len(regions)} regions")
  1391â†’        
  1392â†’        # Print initial status
  1393â†’        rich_status(f"Starting creation of {len(creation_status)} instances across {len(regions)} regions...")
  1394â†’        
  1395â†’        # Test the update mechanism first
  1396â†’        with lock:
  1397â†’            log_messages.append("ðŸ”§ Testing update mechanism...")
  1398â†’            for key in creation_status:
  1399â†’                creation_status[key]["status"] = "ðŸ”§ Testing updates..."
  1400â†’        
  1401â†’        # Start live display (try without screen mode for better compatibility)
  1402â†’        with Live(generate_layout(), refresh_per_second=4, console=console, screen=False) as live:
  1403â†’            # Test update
  1404â†’            time.sleep(2)
  1405â†’            live.update(generate_layout())
  1406â†’            
  1407â†’            # Start threads for each region (up to 10 instances total)
  1408â†’            for region_idx, region in enumerate(regions):
  1409â†’                if len(active_threads) >= 10:  # Max 10 threads
  1410â†’                    break
  1411â†’                
  1412â†’                # Calculate instances for this region
  1413â†’                instances_for_this_region = instances_per_region
  1414â†’                if region_idx == len(regions) - 1:  # Last region gets remaining instances
  1415â†’                    instances_for_this_region += remaining_instances
  1416â†’                    
  1417â†’                thread = threading.Thread(target=create_region_instances, args=(region, instances_for_this_region, live))
  1418â†’                thread.daemon = True
  1419â†’                active_threads.append(thread)
  1420â†’                thread.start()
  1421â†’                
  1422â†’                with lock:
  1423â†’                    log_messages.append(f"ðŸš€ Started creation thread for {region} ({instances_for_this_region} instance(s))")
  1424â†’                
  1425â†’                time.sleep(0.5)  # Small delay between thread starts for visibility
  1426â†’                live.update(generate_layout())
  1427â†’            
  1428â†’            # Wait for all threads to complete
  1429â†’            with lock:
  1430â†’                log_messages.append("â³ Waiting for all instances to complete...")
  1431â†’            live.update(generate_layout())
  1432â†’            
  1433â†’            for thread in active_threads:
  1434â†’                thread.join()
  1435â†’                live.update(generate_layout())
  1436â†’            
  1437â†’            # Save all instances to state
  1438â†’            total_created = 0
  1439â†’            for instance in all_instances:
  1440â†’                state.add_instance(instance)
  1441â†’                total_created += 1
  1442â†’            
  1443â†’            with lock:
  1444â†’                log_messages.append(f"ðŸ’¾ Saved {total_created} instances to state")
  1445â†’                log_messages.append("âœ… All instances created successfully!")
  1446â†’            
  1447â†’            # Final display update
  1448â†’            time.sleep(2)
  1449â†’        
  1450â†’        # Show final results table
  1451â†’        console.print("\n")
  1452â†’        rich_success(f"Successfully created {total_created} instances!")
  1453â†’        
  1454â†’        if total_created > 0:
  1455â†’            console.print("\n")
  1456â†’            cmd_list(state)  # Show the final table
  1457â†’    else:
  1458â†’        # Fallback without table
  1459â†’        total_created = 0
  1460â†’        for region in regions:
  1461â†’            instances = create_instances_in_region(config, region, instances_per_region)
  1462â†’            for instance in instances:
  1463â†’                state.add_instance(instance)
  1464â†’                total_created += 1
  1465â†’                rich_success(f"Created {instance['id']} in {region}")
  1466â†’    
  1467â†’    rich_success(f"Successfully created {total_created} instances")
  1468â†’
  1469â†’def cmd_list(state: SimpleStateManager) -> None:
  1470â†’    """List all managed instances with Rich table."""
  1471â†’    if not check_aws_auth():
  1472â†’        return
  1473â†’    
  1474â†’    instances = state.load_instances()
  1475â†’    
  1476â†’    if not instances:
  1477â†’        rich_status("No instances found")
  1478â†’        return
  1479â†’    
  1480â†’    if RICH_AVAILABLE and console:
  1481â†’        # Create beautiful Rich table with consistent widths
  1482â†’        table = Table(title=f"Managed Instances ({len(instances)} total)", show_header=True, width=120)
  1483â†’        table.add_column("Instance ID", style="cyan", width=20, no_wrap=True)
  1484â†’        table.add_column("Region", style="magenta", width=12, no_wrap=True)
  1485â†’        table.add_column("Type", style="green", width=12, no_wrap=True)
  1486â†’        table.add_column("State", style="yellow", width=12, no_wrap=True)
  1487â†’        table.add_column("Public IP", style="blue", width=16, no_wrap=True)
  1488â†’        table.add_column("Created", style="dim", width=12, no_wrap=True)
  1489â†’        
  1490â†’        for instance in instances:
  1491â†’            # Format creation time
  1492â†’            created = instance.get('created', 'Unknown')
  1493â†’            if created != 'Unknown':
  1494â†’                try:
  1495â†’                    created_dt = datetime.fromisoformat(created.replace('Z', '+00:00'))
  1496â†’                    created = created_dt.strftime('%m-%d %H:%M')
  1497â†’                except:
  1498â†’                    created = 'Unknown'
  1499â†’            
  1500â†’            # Style state column
  1501â†’            state_text = instance.get('state', 'unknown')
  1502â†’            if state_text == 'running':
  1503â†’                state_style = "[bold green]running[/bold green]"
  1504â†’            elif state_text == 'pending':
  1505â†’                state_style = "[bold yellow]pending[/bold yellow]"
  1506â†’            elif state_text in ['stopped', 'terminated']:
  1507â†’                state_style = "[bold red]" + state_text + "[/bold red]"
  1508â†’            else:
  1509â†’                state_style = state_text
  1510â†’            
  1511â†’            table.add_row(
  1512â†’                instance['id'],
  1513â†’                instance['region'],
  1514â†’                instance['type'],
  1515â†’                state_style,
  1516â†’                instance.get('public_ip', 'N/A'),
  1517â†’                created
  1518â†’            )
  1519â†’        
  1520â†’        console.print(table)
  1521â†’    else:
  1522â†’        # Fallback to simple table
  1523â†’        print(f"\nManaged Instances ({len(instances)} total):")
  1524â†’        print("-" * 90)
  1525â†’        print(f"{'ID':<20} {'Region':<15} {'Type':<12} {'State':<10} {'Public IP':<15} {'Created':<16}")
  1526â†’        print("-" * 90)
  1527â†’        
  1528â†’        for instance in instances:
  1529â†’            created = instance.get('created', 'Unknown')
  1530â†’            if created != 'Unknown':
  1531â†’                try:
  1532â†’                    created_dt = datetime.fromisoformat(created.replace('Z', '+00:00'))
  1533â†’                    created = created_dt.strftime('%m-%d %H:%M')
  1534â†’                except:
  1535â†’                    created = 'Unknown'
  1536â†’            
  1537â†’            print(f"{instance['id']:<20} {instance['region']:<15} {instance['type']:<12} "
  1538â†’                  f"{instance['state']:<10} {instance.get('public_ip', 'N/A'):<15} {created:<16}")
  1539â†’
  1540â†’def cmd_destroy(state: SimpleStateManager) -> None:
  1541â†’    """Destroy all managed instances and clean up all created resources."""
  1542â†’    if not check_aws_auth():
  1543â†’        return
  1544â†’    
  1545â†’    instances = state.load_instances()
  1546â†’    
  1547â†’    if not instances:
  1548â†’        rich_status("No instances to destroy")
  1549â†’        # Still try to clean up any orphaned VPCs
  1550â†’        _cleanup_vpcs()
  1551â†’        return
  1552â†’    
  1553â†’    if RICH_AVAILABLE and console:
  1554â†’        # Clear screen and set up layout
  1555â†’        console.clear()
  1556â†’        
  1557â†’        # Create log collector
  1558â†’        log_messages = []
  1559â†’        
  1560â†’        # Create live-updating table for destruction progress
  1561â†’        destruction_status = {}
  1562â†’        for instance in instances:
  1563â†’            key = instance["id"]
  1564â†’            destruction_status[key] = {
  1565â†’                "region": instance["region"],
  1566â†’                "instance_id": instance["id"],
  1567â†’                "status": "ðŸ”„ Terminating...",
  1568â†’                "type": instance["type"],
  1569â†’                "public_ip": instance.get("public_ip", "N/A"),
  1570â†’                "created": instance.get("created", "Unknown")
  1571â†’            }
  1572â†’        
  1573â†’        def generate_destroy_layout():
  1574â†’            # Create the table
  1575â†’            table = Table(title=f"Destroying {len(instances)} instances", show_header=True)
  1576â†’            table.add_column("Region", style="magenta", width=12)
  1577â†’            table.add_column("Instance ID", style="cyan", width=20)
  1578â†’            table.add_column("Status", style="yellow", width=25)
  1579â†’            table.add_column("Type", style="green", width=10)
  1580â†’            table.add_column("Public IP", style="blue", width=15)
  1581â†’            table.add_column("Created", style="dim", width=12)
  1582â†’            
  1583â†’            # Sort: active work at top, completed at bottom
  1584â†’            sorted_items = sorted(destruction_status.items(), key=lambda x: (
  1585â†’                0 if x[1]["status"].startswith("âœ…") else 1,  # Completed items last
  1586â†’                1 if x[1]["status"].startswith("âŒ") else 0,  # Failed items first
  1587â†’                x[0]  # Then by key
  1588â†’            ))
  1589â†’            
  1590â†’            for key, item in sorted_items:
  1591â†’                # Format created time
  1592â†’                created = item["created"]
  1593â†’                if created and created != "Unknown":
  1594â†’                    try:
  1595â†’                        created_dt = datetime.fromisoformat(created.replace('Z', '+00:00'))
  1596â†’                        created = created_dt.strftime('%m-%d %H:%M')
  1597â†’                    except:
  1598â†’                        created = "Unknown"
  1599â†’                
  1600â†’                table.add_row(
  1601â†’                    item["region"],
  1602â†’                    item["instance_id"],
  1603â†’                    item["status"],
  1604â†’                    item["type"],
  1605â†’                    item["public_ip"],
  1606â†’                    created
  1607â†’                )
  1608â†’            
  1609â†’            # Create the log panel
  1610â†’            log_content = "\n".join(log_messages[-20:])  # Show last 20 log messages
  1611â†’            log_panel = Panel(
  1612â†’                log_content,
  1613â†’                title="ðŸ“‹ Log Messages",
  1614â†’                border_style="blue",
  1615â†’                height=8
  1616â†’            )
  1617â†’            
  1618â†’            # Create layout
  1619â†’            layout = Layout()
  1620â†’            layout.split_column(
  1621â†’                Layout(table, name="table", ratio=3),
  1622â†’                Layout(log_panel, name="logs", ratio=1)
  1623â†’            )
  1624â†’            
  1625â†’            return layout
  1626â†’        
  1627â†’        # Group by region
  1628â†’        by_region = {}
  1629â†’        for instance in instances:
  1630â†’            region = instance["region"]
  1631â†’            if region not in by_region:
  1632â†’                by_region[region] = []
  1633â†’            by_region[region].append(instance)
  1634â†’        
  1635â†’        with Live(generate_destroy_layout(), refresh_per_second=2, console=console, screen=True):
  1636â†’            total_terminated = 0
  1637â†’            for region, region_instances in by_region.items():
  1638â†’                try:
  1639â†’                    log_messages.append(f"Terminating {len(region_instances)} instances in {region}...")
  1640â†’                    ec2 = boto3.client("ec2", region_name=region)
  1641â†’                    instance_ids = [inst["id"] for inst in region_instances]
  1642â†’                    
  1643â†’                    # Update status for all instances in this region
  1644â†’                    for instance in region_instances:
  1645â†’                        destruction_status[instance["id"]]["status"] = "ðŸ”„ Terminating..."
  1646â†’                    
  1647â†’                    time.sleep(1)  # Show the terminating status
  1648â†’                    
  1649â†’                    # Terminate instances
  1650â†’                    ec2.terminate_instances(InstanceIds=instance_ids)
  1651â†’                    log_messages.append(f"Successfully terminated {len(instance_ids)} instances in {region}")
  1652â†’                    
  1653â†’                    # Update status to completed
  1654â†’                    for instance in region_instances:
  1655â†’                        destruction_status[instance["id"]]["status"] = "âœ… Terminated"
  1656â†’                    
  1657â†’                    removed = state.remove_instances_by_region(region)
  1658â†’                    total_terminated += removed
  1659â†’                    
  1660â†’                    time.sleep(1)  # Show the completed status
  1661â†’                    
  1662â†’                except Exception as e:
  1663â†’                    log_messages.append(f"Error terminating instances in {region}: {e}")
  1664â†’                    # Update status to failed
  1665â†’                    for instance in region_instances:
  1666â†’                        destruction_status[instance["id"]]["status"] = f"âŒ Error: {str(e)[:15]}..."
  1667â†’                    
  1668â†’                    time.sleep(1)  # Show the error status
  1669â†’            
  1670â†’            # Final update
  1671â†’            time.sleep(2)
  1672â†’    else:
  1673â†’        # Fallback without table
  1674â†’        by_region = {}
  1675â†’        for instance in instances:
  1676â†’            region = instance["region"]
  1677â†’            if region not in by_region:
  1678â†’                by_region[region] = []
  1679â†’            by_region[region].append(instance["id"])
  1680â†’        
  1681â†’        total_terminated = 0
  1682â†’        for region, instance_ids in by_region.items():
  1683â†’            try:
  1684â†’                ec2 = boto3.client("ec2", region_name=region)
  1685â†’                ec2.terminate_instances(InstanceIds=instance_ids)
  1686â†’                removed = state.remove_instances_by_region(region)
  1687â†’                total_terminated += removed
  1688â†’                rich_success(f"Terminated {len(instance_ids)} instances in {region}")
  1689â†’            except Exception as e:
  1690â†’                rich_error(f"Error terminating instances in {region}: {e}")
  1691â†’    
  1692â†’    rich_success(f"Successfully terminated {total_terminated} instances")
  1693â†’    
  1694â†’    # Clean up VPCs and other resources
  1695â†’    _cleanup_vpcs()
  1696â†’
  1697â†’def _cleanup_vpcs() -> None:
  1698â†’    """Clean up VPCs and other resources created by this tool."""
  1699â†’    rich_status("Cleaning up VPCs and other resources...")
  1700â†’    
  1701â†’    # Get regions from config
  1702â†’    config = SimpleConfig()
  1703â†’    regions = config.regions()
  1704â†’    
  1705â†’    if not regions:
  1706â†’        rich_warning("No regions configured for cleanup")
  1707â†’        return
  1708â†’    
  1709â†’    if RICH_AVAILABLE and console:
  1710â†’        with Progress(
  1711â†’            SpinnerColumn(),
  1712â†’            TextColumn("[progress.description]{task.description}"),
  1713â†’            console=console,
  1714â†’            transient=True
  1715â†’        ) as progress:
  1716â†’            total_cleaned = 0
  1717â†’            for region in regions:
  1718â†’                task = progress.add_task(f"Scanning VPCs in {region}...", total=None)
  1719â†’                try:
  1720â†’                    ec2 = boto3.client("ec2", region_name=region)
  1721â†’                    
  1722â†’                    # Find VPCs with SpotDeployer tags
  1723â†’                    vpcs = ec2.describe_vpcs(
  1724â†’                        Filters=[
  1725â†’                            {"Name": "tag:ManagedBy", "Values": ["SpotDeployer"]},
  1726â†’                        ]
  1727â†’                    )
  1728â†’                    
  1729â†’                    for vpc in vpcs["Vpcs"]:
  1730â†’                        vpc_id = vpc["VpcId"]
  1731â†’                        progress.update(task, description=f"Cleaning VPC {vpc_id} in {region}...")
  1732â†’                        try:
  1733â†’                            # Check if VPC has any instances
  1734â†’                            instances = ec2.describe_instances(
  1735â†’                                Filters=[{"Name": "vpc-id", "Values": [vpc_id]}]
  1736â†’                            )
  1737â†’                            
  1738â†’                            has_running_instances = any(
  1739â†’                                instance["State"]["Name"] not in ["terminated", "shutting-down"]
  1740â†’                                for reservation in instances["Reservations"]
  1741â†’                                for instance in reservation["Instances"]
  1742â†’                            )
  1743â†’                            
  1744â†’                            if has_running_instances:
  1745â†’                                progress.remove_task(task)
  1746â†’                                rich_warning(f"VPC {vpc_id} in {region} has running instances, skipping")
  1747â†’                                task = progress.add_task(f"Scanning VPCs in {region}...", total=None)
  1748â†’                                continue
  1749â†’                            
  1750â†’                            # Try basic cleanup
  1751â†’                            # Delete security groups (except default)
  1752â†’                            sgs = ec2.describe_security_groups(
  1753â†’                                Filters=[{"Name": "vpc-id", "Values": [vpc_id]}]
  1754â†’                            )
  1755â†’                            for sg in sgs["SecurityGroups"]:
  1756â†’                                if sg["GroupName"] != "default":
  1757â†’                                    try:
  1758â†’                                        ec2.delete_security_group(GroupId=sg["GroupId"])
  1759â†’                                    except Exception:
  1760â†’                                        pass  # May fail due to dependencies
  1761â†’                            
  1762â†’                            # Delete subnets
  1763â†’                            subnets = ec2.describe_subnets(
  1764â†’                                Filters=[{"Name": "vpc-id", "Values": [vpc_id]}]
  1765â†’                            )
  1766â†’                            for subnet in subnets["Subnets"]:
  1767â†’                                try:
  1768â†’                                    ec2.delete_subnet(SubnetId=subnet["SubnetId"])
  1769â†’                                except Exception:
  1770â†’                                    pass  # May fail due to dependencies
  1771â†’                            
  1772â†’                            # Try to delete VPC
  1773â†’                            try:
  1774â†’                                ec2.delete_vpc(VpcId=vpc_id)
  1775â†’                                progress.remove_task(task)
  1776â†’                                rich_success(f"Cleaned up VPC {vpc_id} in {region}")
  1777â†’                                total_cleaned += 1
  1778â†’                                task = progress.add_task(f"Scanning VPCs in {region}...", total=None)
  1779â†’                            except Exception as e:
  1780â†’                                progress.remove_task(task)
  1781â†’                                rich_warning(f"Could not fully delete VPC {vpc_id}: {e}")
  1782â†’                                rich_status("For comprehensive cleanup, use: uv run -s delete_vpcs.py")
  1783â†’                                task = progress.add_task(f"Scanning VPCs in {region}...", total=None)
  1784â†’                        
  1785â†’                        except Exception as e:
  1786â†’                            progress.remove_task(task)
  1787â†’                            rich_warning(f"Error processing VPC {vpc_id}: {e}")
  1788â†’                            task = progress.add_task(f"Scanning VPCs in {region}...", total=None)
  1789â†’                    
  1790â†’                    progress.remove_task(task)
  1791â†’                
  1792â†’                except Exception as e:
  1793â†’                    progress.remove_task(task)
  1794â†’                    rich_warning(f"Error cleaning up region {region}: {e}")
  1795â†’    else:
  1796â†’        # Fallback without progress bar
  1797â†’        total_cleaned = 0
  1798â†’        for region in regions:
  1799â†’            try:
  1800â†’                ec2 = boto3.client("ec2", region_name=region)
  1801â†’                
  1802â†’                # Find VPCs with SpotDeployer tags
  1803â†’                vpcs = ec2.describe_vpcs(
  1804â†’                    Filters=[
  1805â†’                        {"Name": "tag:ManagedBy", "Values": ["SpotDeployer"]},
  1806â†’                    ]
  1807â†’                )
  1808â†’                
  1809â†’                for vpc in vpcs["Vpcs"]:
  1810â†’                    vpc_id = vpc["VpcId"]
  1811â†’                    try:
  1812â†’                        # Check if VPC has any instances
  1813â†’                        instances = ec2.describe_instances(
  1814â†’                            Filters=[{"Name": "vpc-id", "Values": [vpc_id]}]
  1815â†’                        )
  1816â†’                        
  1817â†’                        has_running_instances = any(
  1818â†’                            instance["State"]["Name"] not in ["terminated", "shutting-down"]
  1819â†’                            for reservation in instances["Reservations"]
  1820â†’                            for instance in reservation["Instances"]
  1821â†’                        )
  1822â†’                        
  1823â†’                        if has_running_instances:
  1824â†’                            rich_warning(f"VPC {vpc_id} in {region} has running instances, skipping")
  1825â†’                            continue
  1826â†’                        
  1827â†’                        # Try basic cleanup
  1828â†’                        rich_status(f"Cleaning up VPC {vpc_id} in {region}...")
  1829â†’                        
  1830â†’                        # Delete security groups (except default)
  1831â†’                        sgs = ec2.describe_security_groups(
  1832â†’                            Filters=[{"Name": "vpc-id", "Values": [vpc_id]}]
  1833â†’                        )
  1834â†’                        for sg in sgs["SecurityGroups"]:
  1835â†’                            if sg["GroupName"] != "default":
  1836â†’                                try:
  1837â†’                                    ec2.delete_security_group(GroupId=sg["GroupId"])
  1838â†’                                except Exception:
  1839â†’                                    pass  # May fail due to dependencies
  1840â†’                        
  1841â†’                        # Delete subnets
  1842â†’                        subnets = ec2.describe_subnets(
  1843â†’                            Filters=[{"Name": "vpc-id", "Values": [vpc_id]}]
  1844â†’                        )
  1845â†’                        for subnet in subnets["Subnets"]:
  1846â†’                            try:
  1847â†’                                ec2.delete_subnet(SubnetId=subnet["SubnetId"])
  1848â†’                            except Exception:
  1849â†’                                pass  # May fail due to dependencies
  1850â†’                        
  1851â†’                        # Try to delete VPC
  1852â†’                        try:
  1853â†’                            ec2.delete_vpc(VpcId=vpc_id)
  1854â†’                            rich_success(f"Cleaned up VPC {vpc_id} in {region}")
  1855â†’                            total_cleaned += 1
  1856â†’                        except Exception as e:
  1857â†’                            rich_warning(f"Could not fully delete VPC {vpc_id}: {e}")
  1858â†’                            rich_status("For comprehensive cleanup, use: uv run -s delete_vpcs.py")
  1859â†’                    
  1860â†’                    except Exception as e:
  1861â†’                        rich_warning(f"Error processing VPC {vpc_id}: {e}")
  1862â†’            
  1863â†’            except Exception as e:
  1864â†’                rich_warning(f"Error cleaning up region {region}: {e}")
  1865â†’    
  1866â†’    if total_cleaned > 0:
  1867â†’        rich_success(f"Cleaned up {total_cleaned} VPCs")
  1868â†’    else:
  1869â†’        rich_status("No VPCs needed cleanup")
  1870â†’
  1871â†’
  1872â†’def cmd_setup() -> None:
  1873â†’    """Setup enhanced configuration."""
  1874â†’    rich_status("Setting up enhanced configuration...")
  1875â†’    
  1876â†’    if not check_aws_auth():
  1877â†’        return
  1878â†’    
  1879â†’    config_data = {
  1880â†’        "aws": {
  1881â†’            "total_instances": 3,
  1882â†’            "username": "ubuntu",
  1883â†’            "files_directory": "files",
  1884â†’            "scripts_directory": "instance/scripts",
  1885â†’            "cloud_init_template": "instance/cloud-init/init-vm-template.yml",
  1886â†’            "startup_script": "instance/scripts/startup.py",
  1887â†’            "bacalhau_data_dir": "/bacalhau_data",
  1888â†’            "bacalhau_node_dir": "/bacalhau_node",
  1889â†’            "bacalhau_config_template": "instance/config/config-template.yaml",
  1890â†’            "docker_compose_template": "instance/scripts/docker-compose.yaml",
  1891â†’            "instance_storage_gb": 20,
  1892â†’            "associate_public_ip": True,
  1893â†’            "tags": {
  1894â†’                "Project": "SpotDeployment",
  1895â†’                "Environment": "Development",
  1896â†’                "ManagedBy": "SpotDeployer"
  1897â†’            }
  1898â†’        },
  1899â†’        "regions": [
  1900â†’            {"us-west-2": {"machine_type": "t3.medium", "image": "auto"}},
  1901â†’            {"us-east-1": {"machine_type": "t3.medium", "image": "auto"}},
  1902â†’            {"eu-west-1": {"machine_type": "t3.medium", "image": "auto"}},
  1903â†’        ]
  1904â†’    }
  1905â†’    
  1906â†’    with open("config.yaml", "w") as f:
  1907â†’        yaml.dump(config_data, f, default_flow_style=False, sort_keys=False)
  1908â†’    
  1909â†’    rich_success("Created config.yaml with enhanced options")
  1910â†’    rich_success("Setup complete!")
  1911â†’    rich_status("ðŸ“‹ Check config.yaml.example for all available options")
  1912â†’
  1913â†’def show_help() -> None:
  1914â†’    """Show help information."""
  1915â†’    if RICH_AVAILABLE and console:
  1916â†’        # Create beautiful Rich panel
  1917â†’        help_content = """[bold cyan]Commands:[/bold cyan]
  1918â†’  [bold green]setup[/bold green]    Create basic configuration
  1919â†’  [bold green]create[/bold green]   Create spot instances in configured regions
  1920â†’  [bold green]list[/bold green]     List all managed instances  
  1921â†’  [bold green]destroy[/bold green]  Terminate instances and clean up ALL resources
  1922â†’  [bold green]help[/bold green]     Show this help
  1923â†’
  1924â†’[bold cyan]Examples:[/bold cyan]
  1925â†’  [dim]uv run -s deploy_spot.py setup     # First time setup[/dim]
  1926â†’  [dim]uv run -s deploy_spot.py create    # Deploy instances[/dim]
  1927â†’  [dim]uv run -s deploy_spot.py list      # Check status[/dim]
  1928â†’  [dim]uv run -s deploy_spot.py destroy   # Cleanup everything[/dim]
  1929â†’
  1930â†’[bold cyan]Files:[/bold cyan]
  1931â†’  [yellow]config.yaml[/yellow]     Configuration file (created by 'setup' command)
  1932â†’  [yellow]instances.json[/yellow]  State file (tracks your instances)
  1933â†’  [yellow]delete_vpcs.py[/yellow]  Advanced VPC cleanup utility
  1934â†’
  1935â†’[bold cyan]Advanced:[/bold cyan]
  1936â†’  [dim]uv run -s delete_vpcs.py --dry-run    # Comprehensive VPC scan[/dim]
  1937â†’  [dim]uv run -s delete_vpcs.py              # Advanced VPC cleanup[/dim]"""
  1938â†’        
  1939â†’        panel = Panel(help_content, 
  1940â†’                     title="[bold white]AWS Spot Instance Deployer - Simple Version[/bold white]",
  1941â†’                     border_style="blue")
  1942â†’        console.print(panel)
  1943â†’    else:
  1944â†’        # Fallback to simple text
  1945â†’        print("""
  1946â†’AWS Spot Instance Deployer
  1947â†’
  1948â†’Commands:
  1949â†’  setup     Create basic configuration
  1950â†’  create    Create spot instances in configured regions
  1951â†’  list      List all managed instances  
  1952â†’  destroy   Terminate instances and clean up ALL resources
  1953â†’  help      Show this help
  1954â†’
  1955â†’Examples:
  1956â†’  uv run -s deploy_spot.py setup     # First time setup
  1957â†’  uv run -s deploy_spot.py create    # Deploy instances
  1958â†’  uv run -s deploy_spot.py list      # Check status
  1959â†’  uv run -s deploy_spot.py destroy   # Cleanup everything
  1960â†’
  1961â†’Files:
  1962â†’  config.yaml     Configuration file (created by 'setup' command)
  1963â†’  instances.json  State file (tracks your instances)
  1964â†’  delete_vpcs.py  Advanced VPC cleanup utility
  1965â†’  
  1966â†’Advanced:
  1967â†’  uv run -s delete_vpcs.py --dry-run    # Comprehensive VPC scan
  1968â†’  uv run -s delete_vpcs.py              # Advanced VPC cleanup
  1969â†’""")
  1970â†’
  1971â†’# =============================================================================
  1972â†’# MAIN ENTRY POINT
  1973â†’# =============================================================================
  1974â†’
  1975â†’def main() -> int:
  1976â†’    """Main entry point."""
  1977â†’    if len(sys.argv) < 2:
  1978â†’        show_help()
  1979â†’        return 0
  1980â†’    
  1981â†’    command = sys.argv[1]
  1982â†’    
  1983â†’    if command in ["help", "--help", "-h"]:
  1984â†’        show_help()
  1985â†’        return 0
  1986â†’    
  1987â†’    if command == "setup":
  1988â†’        cmd_setup()
  1989â†’        return 0
  1990â†’    
  1991â†’    # Load config and state for other commands
  1992â†’    config = SimpleConfig()
  1993â†’    state = SimpleStateManager()
  1994â†’    
  1995â†’    if command == "create":
  1996â†’        cmd_create(config, state)
  1997â†’    elif command == "list":
  1998â†’        cmd_list(state)
  1999â†’    elif command == "destroy":
  2000â†’        cmd_destroy(state)
  2001â†’    else:
  2002â†’        print(f"Unknown command: {command}")
  2003â†’        print("Run 'uv run -s deploy_spot.py help' for usage")
  2004â†’        return 1
  2005â†’    
  2006â†’    return 0
  2007â†’
  2008â†’if __name__ == "__main__":
  2009â†’    sys.exit(main())

<system-reminder>
Whenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.
</system-reminder>

```

---

_**Assistant**_

Perfect! I can see the main function and how commands are handled in the `deploy_spot.py` file. Here's the breakdown of how commands are handled:

## Main Function and Command Structure

The main function is located at **lines 1975-2009** and handles commands through a simple command-line argument parsing system:

```python
def main() -> int:
    """Main entry point."""
    if len(sys.argv) < 2:
        show_help()
        return 0
    
    command = sys.argv[1]  # Get the command from first argument
    
    if command in ["help", "--help", "-h"]:
        show_help()
        return 0
    
    if command == "setup":
        cmd_setup()
        return 0
    
    # Load config and state for other commands
    config = SimpleConfig()
    state = SimpleStateManager()
    
    if command == "create":
        cmd_create(config, state)
    elif command == "list":
        cmd_list(state)
    elif command == "destroy":
        cmd_destroy(state)
    else:
        print(f"Unknown command: {command}")
        print("Run 'uv run -s deploy_spot.py help' for usage")
        return 1
    
    return 0
```

## Current Commands

The existing commands are:

1. **`setup`** - Creates configuration (lines 1872-1911)
2. **`create`** - Creates spot instances (lines 1140-1467)
3. **`list`** - Lists managed instances (lines 1469-1538)
4. **`destroy`** - Terminates instances and cleans up (lines 1540-1695)
5. **`help`** - Shows help information (lines 1913-1969)

## How to Add Your 'node-config' Command

To add a new 'node-config' command that generates sample configuration for N nodes, you would:

1. **Create a new function** (similar to `cmd_setup()`, `cmd_create()`, etc.)
2. **Add the command handling** in the main function
3. **Update the help text** to include the new command

Here's how you can implement it:

### 1. Add the command function before the main function:

```python
def cmd_node_config() -> None:
    """Generate sample configuration for N nodes."""
    if len(sys.argv) < 3:
        rich_error("Usage: uv run -s deploy_spot.py node-config <number_of_nodes>")
        rich_status("Example: uv run -s deploy_spot.py node-config 5")
        return
    
    try:
        num_nodes = int(sys.argv[2])
        if num_nodes <= 0:
            rich_error("Number of nodes must be positive")
            return
    except ValueError:
        rich_error("Number of nodes must be a valid integer")
        return
    
    rich_status(f"Generating configuration for {num_nodes} nodes...")
    
    # Generate sample config with the specified number of nodes
    config_data = {
        "aws": {
            "total_instances": num_nodes,
            "username": "ubuntu",
            "files_directory": "files",
            "scripts_directory": "instance/scripts",
            "cloud_init_template": "instance/cloud-init/init-vm-template.yml",
            "startup_script": "instance/scripts/startup.py",
            "bacalhau_data_dir": "/bacalhau_data",
            "bacalhau_node_dir": "/bacalhau_node",
            "bacalhau_config_template": "instance/config/config-template.yaml",
            "docker_compose_template": "instance/scripts/docker-compose.yaml",
            "instance_storage_gb": 20,
            "associate_public_ip": True,
            "tags": {
                "Project": "SpotDeployment",
                "Environment": "Development",
                "ManagedBy": "SpotDeployer",
                "NodeCount": str(num_nodes)
            }
        },
        "regions": [
            {"us-west-2": {"machine_type": "t3.medium", "image": "auto"}},
            {"us-east-1": {"machine_type": "t3.medium", "image": "auto"}},
            {"eu-west-1": {"machine_type": "t3.medium", "image": "auto"}},
        ]
    }
    
    # Calculate distribution across regions
    regions = config_data["regions"]
    nodes_per_region = max(1, num_nodes // len(regions))
    remaining_nodes = num_nodes % len(regions)
    
    rich_status("Node distribution across regions:")
    for i, region_config in enumerate(regions):
        region_name = list(region_config.keys())[0]
        nodes_in_region = nodes_per_region
        if i < remaining_nodes:
            nodes_in_region += 1
        rich_status(f"  {region_name}: {nodes_in_region} nodes")
    
    # Write configuration file
    config_filename = f"config-{num_nodes}nodes.yaml"
    with open(config_filename, "w") as f:
        yaml.dump(config_data, f, default_flow_style=False, sort_keys=False)
    
    rich_success(f"Generated {config_filename} for {num_nodes} nodes")
    rich_status(f"To use: cp {config_filename} config.yaml")
```

### 2. Update the main function to handle the new command:

```python
def main() -> int:
    """Main entry point."""
    if len(sys.argv) < 2:
        show_help()
        return 0
    
    command = sys.argv[1]
    
    if command in ["help", "--help", "-h"]:
        show_help()
        return 0
    
    if command == "setup":
        cmd_setup()
        return 0
    
    if command == "node-config":  # Add this new command
        cmd_node_config()
        return 0
    
    # Load config and state for other commands
    config = SimpleConfig()
    state = SimpleStateManager()
    
    if command == "create":
        cmd_create(config, state)
    elif command == "list":
        cmd_list(state)
    elif command == "destroy":
        cmd_destroy(state)
    else:
        print(f"Unknown command: {command}")
        print("Run 'uv run -s deploy_spot.py help' for usage")
        return 1
    
    return 0
```

### 3. Update the help text to include the new command:

In the `show_help()` function, update the help content to include:

```python
help_content = """[bold cyan]Commands:[/bold cyan]
  [bold green]setup[/bold green]       Create basic configuration
  [bold green]node-config[/bold green] Generate sample configuration for N nodes
  [bold green]create[/bold green]      Create spot instances in configured regions
  [bold green]list[/bold green]        List all managed instances  
  [bold green]destroy[/bold green]     Terminate instances and clean up ALL resources
  [bold green]help[/bold green]        Show this help

[bold cyan]Examples:[/bold cyan]
  [dim]uv run -s deploy_spot.py setup          # First time setup[/dim]
  [dim]uv run -s deploy_spot.py node-config 5  # Generate config for 5 nodes[/dim]
  [dim]uv run -s deploy_spot.py create         # Deploy instances[/dim]
  [dim]uv run -s deploy_spot.py list           # Check status[/dim]
  [dim]uv run -s deploy_spot.py destroy        # Cleanup everything[/dim]
```

## Key Points:

1. **Command parsing** happens in `main()` by checking `sys.argv[1]`
2. **Each command** has its own dedicated function (e.g., `cmd_setup()`, `cmd_create()`)
3. **Configuration and state** are loaded only for commands that need them
4. **Rich formatting** is used throughout for beautiful terminal output
5. **Error handling** includes helpful usage messages

The file structure shows this is a well-organized single-file implementation with clear separation of concerns between configuration management, AWS operations, and command handling.

---

